---
# Flower Federated Learning — OneFlow Service Template
# Deploys a SuperLink coordinator + N SuperNode training nodes
#
# Usage:
#   oneflow-template create flower-cluster.json   (convert YAML→JSON first)
#   oneflow-template instantiate <template_id>
#
# References:
#   spec/08-single-site-orchestration.md

type: 'SERVICE_TEMPLATE'

template_body:
  name: 'Flower Federated Learning'
  deployment: 'straight'
  ready_status_gate: true
  shutdown_action: 'shutdown'

  # ── Service Inputs ─────────────────────────────────────────────────
  # These 5 fields appear on the main instantiation form.
  # Every other setting uses sensible defaults inside the appliance.
  user_inputs:
    ONEAPP_FL_FRAMEWORK: 'O|list|Machine learning framework|pytorch,tensorflow,sklearn|pytorch'
    ONEAPP_FL_NUM_ROUNDS: 'O|number|Number of federated training rounds||3'
    ONEAPP_FL_STRATEGY: 'O|list|Model aggregation strategy|FedAvg,FedProx,FedAdam,Krum,Bulyan,FedTrimmedAvg|FedAvg'
    ONEAPP_FL_MIN_AVAILABLE_CLIENTS: 'O|number|Minimum SuperNodes required to start training||2'
    ONEAPP_FL_TLS_ENABLED: 'O|boolean|Encrypt communication between SuperLink and SuperNodes||NO'
    ONEAPP_FL_GPU_ENABLED: 'O|boolean|Enable GPU acceleration for model training||NO'

  networks:
    Private: 'M|network|Private network for FL cluster| |id::'

  roles:
    # ── SuperLink: the central coordinator (singleton) ───────────────
    - name: 'superlink'
      cardinality: 1
      min_vms: 1
      max_vms: 1
      cooldown: 60
      # vm_template: Replace with your actual SuperLink VM template ID
      vm_template: 0
      parents: []

      vm_template_contents: |
        NIC = [ NETWORK_ID = "$Private" ]
        ONEAPP_FL_FRAMEWORK = "$ONEAPP_FL_FRAMEWORK"
        ONEAPP_FL_NUM_ROUNDS = "$ONEAPP_FL_NUM_ROUNDS"
        ONEAPP_FL_STRATEGY = "$ONEAPP_FL_STRATEGY"
        ONEAPP_FL_MIN_AVAILABLE_CLIENTS = "$ONEAPP_FL_MIN_AVAILABLE_CLIENTS"
        ONEAPP_FL_TLS_ENABLED = "$ONEAPP_FL_TLS_ENABLED"

    # ── SuperNode: training nodes (scalable) ─────────────────────────
    - name: 'supernode'
      cardinality: 2
      min_vms: 2
      max_vms: 10
      cooldown: 30
      # vm_template: Replace with your actual SuperNode VM template ID
      vm_template: 0
      parents:
        - 'superlink'

      vm_template_contents: |
        NIC = [ NETWORK_ID = "$Private" ]
        ONEAPP_FL_FRAMEWORK = "$ONEAPP_FL_FRAMEWORK"
        ONEAPP_FL_NUM_ROUNDS = "$ONEAPP_FL_NUM_ROUNDS"
        ONEAPP_FL_STRATEGY = "$ONEAPP_FL_STRATEGY"
        ONEAPP_FL_MIN_AVAILABLE_CLIENTS = "$ONEAPP_FL_MIN_AVAILABLE_CLIENTS"
        ONEAPP_FL_TLS_ENABLED = "$ONEAPP_FL_TLS_ENABLED"
        ONEAPP_FL_GPU_ENABLED = "$ONEAPP_FL_GPU_ENABLED"

      elasticity_policies: []
      scheduled_policies: []
