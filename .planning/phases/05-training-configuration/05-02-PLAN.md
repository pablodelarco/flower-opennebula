---
phase: 05-training-configuration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - spec/03-contextualization-reference.md
  - spec/08-single-site-orchestration.md
  - spec/00-overview.md
autonomous: true

must_haves:
  truths:
    - "A reader can find all Phase 5 variables in the contextualization reference table with complete USER_INPUT definitions, validation rules, and Flower mappings"
    - "The OneFlow service template includes the new Phase 5 SuperLink user_inputs for strategy parameters and checkpointing"
    - "The overview document references Phase 5 spec section and marks ML-01/ML-04 requirements"
    - "FL_STRATEGY list is updated from 3 to 6 options in all locations (contextualization reference, OneFlow template)"
  artifacts:
    - path: "spec/03-contextualization-reference.md"
      provides: "Updated contextualization reference with 8 new Phase 5 variables and FL_STRATEGY extension"
      contains: "FL_CHECKPOINT_ENABLED"
    - path: "spec/08-single-site-orchestration.md"
      provides: "Updated OneFlow service template with Phase 5 SuperLink user_inputs"
      contains: "FL_CHECKPOINT_ENABLED"
    - path: "spec/00-overview.md"
      provides: "Updated overview with Phase 5 reference"
      contains: "Training Configuration"
  key_links:
    - from: "spec/09-training-configuration.md"
      to: "spec/03-contextualization-reference.md"
      via: "Variable definitions cross-referenced"
      pattern: "Phase 5"
    - from: "spec/09-training-configuration.md"
      to: "spec/08-single-site-orchestration.md"
      via: "SuperLink user_inputs updated"
      pattern: "FL_STRATEGY.*Krum"
---

<objective>
Update existing spec files to integrate Phase 5 training configuration: add new variables to the contextualization reference, extend the OneFlow service template with Phase 5 SuperLink user_inputs, and update the overview.

Purpose: Phase 5 introduces 8 new contextualization variables and extends FL_STRATEGY from 3 to 6 options. These must be reflected in the authoritative reference documents (contextualization reference, OneFlow service template, overview) to maintain spec consistency.

Output: Updated `spec/03-contextualization-reference.md`, `spec/08-single-site-orchestration.md`, and `spec/00-overview.md`.
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-training-configuration/05-RESEARCH.md

@spec/09-training-configuration.md
@spec/03-contextualization-reference.md
@spec/08-single-site-orchestration.md
@spec/00-overview.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update contextualization reference with Phase 5 variables</name>
  <files>spec/03-contextualization-reference.md</files>
  <action>
Read and update spec/03-contextualization-reference.md with the following changes:

**Section 1 (Purpose and Scope):**
- Update scope text to mention Phase 5 variables are now functional
- Update variable count summary table: add "Phase 5 strategy/checkpointing" row with count 8, appliance SuperLink

**Section 3 (SuperLink Parameters):**
- Update FL_STRATEGY row #3: change USER_INPUT from `"O|list|Aggregation strategy|FedAvg,FedProx,FedAdam|FedAvg"` to `"O|list|Aggregation strategy|FedAvg,FedProx,FedAdam,Krum,Bulyan,FedTrimmedAvg|FedAvg"`. Update validation rule to include all 6 options.
- Add 8 new rows (#12-19) to the SuperLink parameter table:

| # | Context Variable | USER_INPUT Definition | Type | Default | Validation Rule | Flower Mapping |
| 12 | FL_PROXIMAL_MU | O|number-float|FedProx proximal term (mu)||1.0 | number-float | 1.0 | Non-negative float (>=0.0); ignored if FL_STRATEGY != FedProx | Strategy param: proximal_mu |
| 13 | FL_SERVER_LR | O|number-float|Server-side learning rate||0.1 | number-float | 0.1 | Positive float (>0.0); ignored if FL_STRATEGY != FedAdam | Strategy param: eta (server learning rate) |
| 14 | FL_CLIENT_LR | O|number-float|Client-side learning rate||0.1 | number-float | 0.1 | Positive float (>0.0); ignored if FL_STRATEGY != FedAdam | Strategy param: eta_l (client learning rate) |
| 15 | FL_NUM_MALICIOUS | O|number|Expected malicious clients (Krum/Bulyan)||0 | number | 0 | Non-negative integer (>=0); if Krum: n>=2f+3; if Bulyan: n>=4f+3 | Strategy param: num_malicious_clients |
| 16 | FL_TRIM_BETA | O|number-float|Trim fraction per tail (FedTrimmedAvg)||0.2 | number-float | 0.2 | Float in range (0.0, 0.5); ignored if FL_STRATEGY != FedTrimmedAvg | Strategy param: beta |
| 17 | FL_CHECKPOINT_ENABLED | O|boolean|Enable model checkpointing||NO | boolean | NO | YES or NO | ServerApp: enables checkpoint saving |
| 18 | FL_CHECKPOINT_INTERVAL | O|number|Save checkpoint every N rounds||5 | number | 5 | Positive integer (>0); ignored if FL_CHECKPOINT_ENABLED != YES | ServerApp: checkpoint frequency |
| 19 | FL_CHECKPOINT_PATH | O|text|Checkpoint directory (container path)||/app/checkpoints | text | /app/checkpoints | Non-empty string | Docker mount: -v /opt/flower/checkpoints:{path}:rw |

- Update the introductory text: "These 19 variables configure..." (was 11)
- Update the SuperLink USER_INPUT Block (Copy-Paste Ready) to include all 19 variables

**Section 6 (Phase 2+ Placeholder Parameters):**
- Phase 5 variables are now FUNCTIONAL, not placeholder. Do NOT add Phase 5 vars here.
- But no changes needed -- Phase 5 variables were not previously listed as placeholders (only Phase 2, 3, 6 were).

**Section 8 (Validation Strategy):**
- Add validation rules for the 8 new variables to the "Validation Rules by Variable" table
- Add the FL_STRATEGY validation update (now 6 valid values instead of 3)
- Add the validation pseudocode for Phase 5 variables (extend the existing validate_config function):
  - Float validation for FL_PROXIMAL_MU, FL_SERVER_LR, FL_CLIENT_LR, FL_TRIM_BETA
  - Byzantine client count validation for Krum/Bulyan
  - Boolean validation for FL_CHECKPOINT_ENABLED
  - Conditional ignore logging for strategy-specific params when FL_STRATEGY does not match

**Section 10 (Parameter Interaction Notes):**
- Add Section 10g: FL_STRATEGY and Strategy-Specific Parameters
  - When FL_STRATEGY=FedAvg: FL_PROXIMAL_MU, FL_SERVER_LR, FL_CLIENT_LR, FL_NUM_MALICIOUS, FL_TRIM_BETA are all ignored (logged as "INFO: FL_PROXIMAL_MU ignored -- only applies to FedProx strategy")
  - When FL_STRATEGY=Krum: FL_NUM_MALICIOUS is validated against FL_MIN_AVAILABLE_CLIENTS. If n < 2f+3, boot logs a warning (not fatal -- operator may be adding more nodes).
  - When FL_STRATEGY=FedProx: FL_PROXIMAL_MU=0.0 makes FedProx identical to FedAvg. Log a warning.

- Add Section 10h: FL_CHECKPOINT_ENABLED and Checkpoint Variables
  - When FL_CHECKPOINT_ENABLED=NO (default): FL_CHECKPOINT_INTERVAL and FL_CHECKPOINT_PATH are ignored. No checkpoint volume mount is added to the Docker run command.
  - When FL_CHECKPOINT_ENABLED=YES: configure.sh creates /opt/flower/checkpoints, adds -v mount to Docker run command.

**Appendix (Variable Cross-Reference Matrix):**
- Add all 8 new variables to the matrix (all SuperLink-only, Phase 5)
- Update FL_STRATEGY phase column to show "1 (extended Phase 5)"
- Update total variable count

The updated total should be:
| Category | Phase 1 Count | Phase 3 Addition | Phase 5 Addition | New Count |
| SuperLink parameters | 11 | 0 | +8 | 19 |
| SuperNode parameters | 7 | +1 (FL_USE_CASE) | 0 | 8 |
| Shared infrastructure | 5 | 0 | 0 | 5 |
| Phase 2+ placeholders | 6 | -1 (ML_FRAMEWORK activated) | 0 | 5 |
| **Total** | **29** | **+1** | **+8** | **38** |
  </action>
  <verify>
Grep spec/03-contextualization-reference.md for:
- "FL_CHECKPOINT_ENABLED" (new variable present)
- "Krum,Bulyan,FedTrimmedAvg" (FL_STRATEGY extension)
- "FL_PROXIMAL_MU" (strategy-specific variable)
- "19 variables" or "19" (updated SuperLink parameter count)
- "38" (updated total count)
- Count occurrences of new variable names to confirm they appear in parameter table, USER_INPUT block, validation rules, and cross-reference matrix
  </verify>
  <done>
spec/03-contextualization-reference.md is updated with all 8 new Phase 5 variables in the SuperLink parameter table, FL_STRATEGY extended to 6 options, validation rules added, parameter interaction notes added, cross-reference matrix updated, total variable count is 38.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update OneFlow service template and overview</name>
  <files>spec/08-single-site-orchestration.md, spec/00-overview.md</files>
  <action>
**Update spec/08-single-site-orchestration.md:**

Read and update the following sections:

1. **Section 1 (Purpose and Scope) -- "What this section does NOT cover" list:**
   - Change "Training configuration, aggregation strategy internals, and checkpointing (Phase 5)" to "Training configuration internals and checkpointing (see `spec/09-training-configuration.md`)"
   - Add cross-reference: Training configuration: [`spec/09-training-configuration.md`](09-training-configuration.md)

2. **Section 2 (Service Template Architecture) -- SuperLink Role-Level user_inputs table:**
   - Add the new Phase 5 SuperLink variables:

| Variable | Why Role-Level |
| FL_PROXIMAL_MU | FedProx proximal term is a server-side strategy parameter. |
| FL_SERVER_LR | FedAdam server learning rate is a server-side parameter. |
| FL_CLIENT_LR | FedAdam client learning rate is configured at server level (forwarded to clients via strategy). |
| FL_NUM_MALICIOUS | Byzantine client count is a server-side aggregation parameter. |
| FL_TRIM_BETA | FedTrimmedAvg trim fraction is a server-side aggregation parameter. |
| FL_CHECKPOINT_ENABLED | Only the SuperLink saves checkpoints. |
| FL_CHECKPOINT_INTERVAL | Only the SuperLink saves checkpoints. |
| FL_CHECKPOINT_PATH | Only the SuperLink saves checkpoints. |

   - Keep the existing 5 variables (FL_NUM_ROUNDS, FL_STRATEGY, FL_MIN_FIT_CLIENTS, FL_MIN_EVALUATE_CLIENTS, FL_MIN_AVAILABLE_CLIENTS)

3. **Section 3 (Complete Service Template JSON):**
   - Update the SuperLink role's user_inputs in the JSON to include all 13 SuperLink role-level variables (existing 5 + new 8):

```json
"user_inputs": {
  "FL_NUM_ROUNDS": "O|number|Number of federated learning rounds||3",
  "FL_STRATEGY": "O|list|Aggregation strategy|FedAvg,FedProx,FedAdam,Krum,Bulyan,FedTrimmedAvg|FedAvg",
  "FL_MIN_FIT_CLIENTS": "O|number|Minimum clients for training round||2",
  "FL_MIN_EVALUATE_CLIENTS": "O|number|Minimum clients for evaluation||2",
  "FL_MIN_AVAILABLE_CLIENTS": "O|number|Minimum available clients to start||2",
  "FL_PROXIMAL_MU": "O|number-float|FedProx proximal term (mu)||1.0",
  "FL_SERVER_LR": "O|number-float|Server-side learning rate||0.1",
  "FL_CLIENT_LR": "O|number-float|Client-side learning rate||0.1",
  "FL_NUM_MALICIOUS": "O|number|Expected malicious clients (Krum/Bulyan)||0",
  "FL_TRIM_BETA": "O|number-float|Trim fraction per tail (FedTrimmedAvg)||0.2",
  "FL_CHECKPOINT_ENABLED": "O|boolean|Enable model checkpointing||NO",
  "FL_CHECKPOINT_INTERVAL": "O|number|Save checkpoint every N rounds||5",
  "FL_CHECKPOINT_PATH": "O|text|Checkpoint directory (container path)||/app/checkpoints"
}
```

   - Update the SuperLink role annotations to mention "13 variables" (was "5 variables")
   - NOTE: FL_STRATEGY value list updated to include Krum, Bulyan, FedTrimmedAvg

4. **Section 9 (Service Lifecycle Management) -- Failure Handling subsection:**
   - Add a paragraph about SuperLink crash recovery WITH checkpoints: "When checkpointing is enabled (FL_CHECKPOINT_ENABLED=YES), the restarted container loads the latest checkpoint as the initial model weights, resuming training from the last saved state rather than starting from scratch. See `spec/09-training-configuration.md`, Sections 7 and 9 for the complete failure recovery specification."

**Update spec/00-overview.md:**

Read and update the following:

1. **Header metadata:**
   - Update Phases line to include Phase 5: "Phases: 01 - Base Appliance Architecture, 02 - Security and Certificate Automation, 03 - ML Framework Variants, 04 - Single-Site Orchestration, 05 - Training Configuration"
   - Add ML-01, ML-04 to Requirements line

2. **Section 1 (Scope):**
   - Move "Training configuration and checkpointing (Phase 5)" from "does NOT cover" to "covers" list
   - Add to covers: "Training configuration: aggregation strategy selection, parameter exposure, model checkpointing, and failure recovery (Phase 5)."

3. **Section 4 (Spec Sections):**
   - Add Phase 5 table:
```
### Phase 5: Training Configuration

| Section | File | Requirement | Summary |
|---------|------|-------------|---------|
| Training Configuration | [`spec/09-training-configuration.md`](09-training-configuration.md) | ML-01, ML-04 | Aggregation strategy selection (6 strategies), strategy-specific parameters, model checkpointing, resume workflow, failure recovery. |
```

4. **Section 7 (Key Decisions):**
   - Do NOT add Phase 5 decisions here yet. Decisions will be added to STATE.md by the execution workflow after plan completion.

5. **Version bump:**
   - Bump version from 1.2 to 1.3 in the footer

Do NOT change any other parts of these files. Minimal, targeted updates only.
  </action>
  <verify>
For spec/08-single-site-orchestration.md:
- Grep for "FL_CHECKPOINT_ENABLED" in the service template JSON
- Grep for "Krum,Bulyan,FedTrimmedAvg" in the FL_STRATEGY user_input
- Grep for "09-training-configuration" (cross-reference)
- Verify the JSON has 13 SuperLink user_inputs entries

For spec/00-overview.md:
- Grep for "Training Configuration" in the spec sections table
- Grep for "ML-01" (requirement reference)
- Grep for "09-training-configuration.md" (file reference)
- Grep for "Version: 1.3" (version bump)
  </verify>
  <done>
spec/08-single-site-orchestration.md has the updated OneFlow service template JSON with all 13 SuperLink user_inputs, FL_STRATEGY extended to 6 options, and cross-reference to spec/09. spec/00-overview.md references Phase 5 in the spec sections table with ML-01/ML-04 requirements and version bumped to 1.3.
  </done>
</task>

</tasks>

<verification>
- spec/03-contextualization-reference.md has 8 new variables, FL_STRATEGY extended, validation rules, variable count 38
- spec/08-single-site-orchestration.md has 13 SuperLink user_inputs in JSON, FL_STRATEGY with 6 options
- spec/00-overview.md references Phase 5, version 1.3
- All cross-references between spec/09 and existing specs are bidirectional
</verification>

<success_criteria>
1. A reader consulting spec/03-contextualization-reference.md can find every Phase 5 variable with its complete definition
2. A reader deploying via the OneFlow service template sees all training configuration parameters exposed as SuperLink user_inputs
3. The overview document correctly references the new Phase 5 spec section
4. FL_STRATEGY is consistently updated to 6 options across all spec files
</success_criteria>

<output>
After completion, create `.planning/phases/05-training-configuration/05-02-SUMMARY.md`
</output>
