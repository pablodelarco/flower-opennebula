---
phase: 08-monitoring-and-observability
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - spec/03-contextualization-reference.md
  - spec/01-superlink-appliance.md
  - spec/02-supernode-appliance.md
  - spec/00-overview.md
autonomous: true

must_haves:
  truths:
    - "FL_LOG_FORMAT, FL_METRICS_ENABLED, FL_METRICS_PORT, and FL_DCGM_ENABLED appear in the contextualization reference with complete definitions"
    - "The SuperLink appliance spec references the metrics exporter and JSON log formatter integration"
    - "The SuperNode appliance spec references the DCGM Exporter sidecar and JSON log formatter integration"
    - "The overview document lists Phase 8 monitoring and observability in its scope"
  artifacts:
    - path: "spec/03-contextualization-reference.md"
      provides: "Updated contextualization reference with Phase 8 monitoring variables"
      contains: "FL_METRICS_ENABLED"
    - path: "spec/01-superlink-appliance.md"
      provides: "SuperLink spec updated with metrics exporter integration"
      contains: "FL_METRICS_ENABLED"
    - path: "spec/02-supernode-appliance.md"
      provides: "SuperNode spec updated with DCGM Exporter sidecar"
      contains: "FL_DCGM_ENABLED"
    - path: "spec/00-overview.md"
      provides: "Updated overview with Phase 8 scope"
      contains: "Monitoring and observability"
  key_links:
    - from: "spec/03-contextualization-reference.md"
      to: "spec/13-monitoring-observability.md"
      via: "Phase 8 variable definitions reference the monitoring spec"
      pattern: "spec/13-monitoring-observability"
    - from: "spec/01-superlink-appliance.md"
      to: "spec/13-monitoring-observability.md"
      via: "SuperLink boot references monitoring spec for metrics exporter"
      pattern: "spec/13"
    - from: "spec/02-supernode-appliance.md"
      to: "spec/13-monitoring-observability.md"
      via: "SuperNode boot references monitoring spec for DCGM sidecar"
      pattern: "spec/13"
---

<objective>
Integrate Phase 8 monitoring and observability into existing spec documents: add 4 new contextualization variables to the variable reference, update SuperLink and SuperNode appliance specs with monitoring integration points (metrics exporter, DCGM sidecar, JSON logging), and update the overview document to include Phase 8 scope.

Purpose: Ensures the new Phase 8 variables are discoverable in the central reference and that readers navigating from existing appliance specs can find the monitoring content.

Output: Updated spec/03-contextualization-reference.md, spec/01-superlink-appliance.md, spec/02-supernode-appliance.md, and spec/00-overview.md with Phase 8 integration.
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-monitoring-and-observability/08-01-SUMMARY.md
@spec/13-monitoring-observability.md
@spec/03-contextualization-reference.md
@spec/01-superlink-appliance.md
@spec/02-supernode-appliance.md
@spec/00-overview.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 8 variables to contextualization reference</name>
  <files>spec/03-contextualization-reference.md</files>
  <action>
Update spec/03-contextualization-reference.md to integrate Phase 8 monitoring variables. Follow the exact pattern used for Phase 5, Phase 6, and Phase 7 variable additions.

**1. Update the scope statement (Section 1):**
- Extend the scope description to mention Phase 8 (monitoring) variables alongside the existing Phase 5, Phase 6, and Phase 7 mentions. Add: "Phase 8 variables (FL_LOG_FORMAT, FL_METRICS_ENABLED, FL_METRICS_PORT, FL_DCGM_ENABLED) are functional and documented in Sections 3-5."

**2. Update the variable count summary table (Section 1):**
- Add a row: "Phase 8 monitoring/logging | 4 | SuperLink/SuperNode/Service"
- Update the SuperLink count: add 2 (FL_METRICS_ENABLED, FL_METRICS_PORT) to current count
- Update the SuperNode count: add 1 (FL_DCGM_ENABLED) to current count
- FL_LOG_FORMAT is a service-level variable (applies to both via OneFlow) -- add to the shared/service category or note it separately
- Update total variable count by adding 4
- Add a note explaining Phase 8 count distribution similar to existing Phase 5/6/7 notes

**3. Add Phase 8 variables to SuperLink Parameters (Section 3):**
- Add FL_METRICS_ENABLED: O|boolean|Enable Prometheus metrics exporter||NO. Default NO. When YES: starts prometheus_client HTTP server on FL_METRICS_PORT. ServerApp FAB must include prometheus_client dependency.
- Add FL_METRICS_PORT: O|number|Prometheus metrics exporter port||9101. Default 9101. Integer 1024-65535. Must not conflict with 9091-9093 (Flower ports). Only effective when FL_METRICS_ENABLED=YES.
- Update SuperLink parameter count accordingly.
- Add both to SuperLink USER_INPUT Block under "# Phase 8: Monitoring" comment.

**4. Add Phase 8 variable to SuperNode Parameters (Section 4):**
- Add FL_DCGM_ENABLED: O|boolean|Enable DCGM GPU metrics exporter||NO. Default NO. When YES: starts DCGM Exporter sidecar (docker pull + docker run on port 9400). Requires FL_GPU_ENABLED=YES. If GPU not available, sidecar not started (warning logged).
- Update SuperNode parameter count accordingly.
- Add to SuperNode USER_INPUT Block under "# Phase 8: Monitoring" comment.

**5. Add FL_LOG_FORMAT to the shared/service section (Section 5 or wherever FLOWER_VERSION and FL_LOG_LEVEL live as shared vars):**
- FL_LOG_FORMAT: O|list|Log output format|text,json|text. Service-level variable (OneFlow). Applies to both SuperLink and SuperNode. When "json": FlowerJSONFormatter replaces default text formatter on flwr logger. When "text": Flower's default format (no change).
- Add to both SuperLink and SuperNode USER_INPUT Blocks if the shared vars pattern requires it, or add to the service-level section following existing FL_LOG_LEVEL pattern.

**6. Add validation rules (Section 8 or validation section):**
- FL_LOG_FORMAT: must be "text" or "json". Error: "Invalid FL_LOG_FORMAT: '${VALUE}'. Must be 'text' or 'json'."
- FL_METRICS_ENABLED: standard boolean (YES/NO).
- FL_METRICS_PORT: integer 1024-65535, not in {9091, 9092, 9093}. Error: "Invalid FL_METRICS_PORT: '${VALUE}'. Must be integer 1024-65535, not 9091-9093."
- FL_DCGM_ENABLED: standard boolean (YES/NO). Cross-check: if YES and FL_GPU_ENABLED != YES, log warning (not fatal).
- Add validation pseudocode for all 4 variables in the validate_config() function.

**7. Add parameter interaction notes (Section 10 or interactions section):**
- FL_METRICS_ENABLED and FL_METRICS_PORT: FL_METRICS_PORT only effective when FL_METRICS_ENABLED=YES. If FL_METRICS_ENABLED=NO, port is unused.
- FL_DCGM_ENABLED and FL_GPU_ENABLED: FL_DCGM_ENABLED=YES requires FL_GPU_ENABLED=YES. If GPU not detected at boot (Phase 6 Step 9), DCGM sidecar not started regardless of FL_DCGM_ENABLED.
- FL_LOG_FORMAT and FL_LOG_LEVEL: both apply simultaneously. JSON format respects the same log level filtering. Cross-reference spec/13-monitoring-observability.md Section 3.

**8. Update the Appendix cross-reference matrix:**
- Add FL_LOG_FORMAT: Y (SuperLink), Y (SuperNode), Y (OneFlow), Phase 8
- Add FL_METRICS_ENABLED: Y (SuperLink), --, --, Phase 8
- Add FL_METRICS_PORT: Y (SuperLink), --, --, Phase 8
- Add FL_DCGM_ENABLED: --, Y (SuperNode), --, Phase 8

**9. Update the version footer:**
- Bump version from current to next (e.g., 1.3 to 1.4 or 1.4 to 1.5 depending on current)
- Update phase note to "(updated Phase 8)"
  </action>
  <verify>
- grep "FL_METRICS_ENABLED" spec/03-contextualization-reference.md
- grep "FL_METRICS_PORT" spec/03-contextualization-reference.md
- grep "FL_DCGM_ENABLED" spec/03-contextualization-reference.md
- grep "FL_LOG_FORMAT" spec/03-contextualization-reference.md
- grep "Phase 8" spec/03-contextualization-reference.md
  </verify>
  <done>spec/03-contextualization-reference.md includes all 4 new Phase 8 variables with complete definitions, validation rules, interaction notes, and cross-reference matrix entries. Variable count updated. Version bumped.</done>
</task>

<task type="auto">
  <name>Task 2: Update appliance specs and overview with Phase 8 integration</name>
  <files>spec/01-superlink-appliance.md, spec/02-supernode-appliance.md, spec/00-overview.md</files>
  <action>
**Update spec/01-superlink-appliance.md:**

1. In the boot sequence section, add a note about monitoring integration at the appropriate steps:
   - After the validate_config step: "When FL_LOG_FORMAT=json, the JSON log formatter is configured on the flwr logger before container start. See [`spec/13-monitoring-observability.md`](13-monitoring-observability.md) Section 3."
   - After the start Flower container step: "When FL_METRICS_ENABLED=YES, the Prometheus metrics HTTP server starts on FL_METRICS_PORT (default 9101). The ServerApp FAB must include prometheus_client in its dependencies. See [`spec/13-monitoring-observability.md`](13-monitoring-observability.md) Section 5."

2. In the image components table, add a note that prometheus_client is NOT in the base image -- it is a ServerApp FAB dependency.

3. In the ports/network section (if one exists), add port 9101 as optional (FL_METRICS_ENABLED=YES).

4. Add a brief "Monitoring Integration" subsection (or add to an existing integration/extensions section) that cross-references spec/13:
   "The SuperLink supports two monitoring tiers: structured JSON logging (OBS-01, enabled via FL_LOG_FORMAT=json) and Prometheus metrics export (OBS-02, enabled via FL_METRICS_ENABLED=YES on port FL_METRICS_PORT). See [`spec/13-monitoring-observability.md`](13-monitoring-observability.md) for the complete monitoring specification."

**Update spec/02-supernode-appliance.md:**

1. In the boot sequence section, add monitoring integration notes:
   - After validate_config step: "When FL_LOG_FORMAT=json, the JSON log formatter is configured on the flwr logger. See [`spec/13-monitoring-observability.md`](13-monitoring-observability.md) Section 3."
   - After the GPU Detection step (Step 14 from Phase 6): "New Step 15: When FL_DCGM_ENABLED=YES AND FL_GPU_ENABLED=YES AND GPU was detected, start the DCGM Exporter sidecar container (docker pull + docker run on port 9400). See [`spec/13-monitoring-observability.md`](13-monitoring-observability.md) Section 6. If image pull fails, log warning and continue (degraded monitoring, not fatal)."

2. In the image components table, add dcgm-exporter as an optional component (pulled at boot, not pre-baked).

3. Update the boot step count if needed (was 14 after Phase 6, now 15 with DCGM sidecar step).

4. Add a brief "Monitoring Integration" subsection cross-referencing spec/13:
   "The SuperNode supports two monitoring tiers: structured JSON logging (OBS-01, enabled via FL_LOG_FORMAT=json) and DCGM GPU metrics export (OBS-02, enabled via FL_DCGM_ENABLED=YES on port 9400). See [`spec/13-monitoring-observability.md`](13-monitoring-observability.md) for the complete monitoring specification."

**Update spec/00-overview.md:**

1. Update the Phases line in the header to include Phase 8:
   - Add "08 - Monitoring and Observability" to the Phases list.

2. Update the Requirements line:
   - Add OBS-01, OBS-02 to the Requirements list.

3. Update the scope section (Section 1):
   - Add to "What this specification covers": "Monitoring and observability: structured JSON logging for FL training events, Prometheus/Grafana metrics stack, GPU telemetry via DCGM, pre-built dashboards, alerting rules (Phase 8)."
   - Remove "Monitoring and observability (Phase 8)" from "What this specification does NOT cover" (if listed).

4. In the spec document table of contents (the listing at the bottom or wherever specs are indexed), add:
   - spec/13-monitoring-observability.md -- Monitoring and observability (OBS-01, OBS-02)

5. In the architecture diagram section (Section 2), add a note after the existing multi-site note:
   "**Monitoring (Phase 8):** The SuperLink exposes Flower training metrics on port 9101 when FL_METRICS_ENABLED=YES. GPU-enabled SuperNodes expose DCGM GPU metrics on port 9400 when FL_DCGM_ENABLED=YES. Both emit structured JSON logs when FL_LOG_FORMAT=json. See [`spec/13-monitoring-observability.md`](13-monitoring-observability.md) for the complete monitoring architecture."
  </action>
  <verify>
- grep "spec/13-monitoring-observability" spec/01-superlink-appliance.md
- grep "spec/13-monitoring-observability" spec/02-supernode-appliance.md
- grep "Monitoring" spec/00-overview.md
- grep "OBS-01" spec/00-overview.md
- grep "OBS-02" spec/00-overview.md
- grep "FL_METRICS_ENABLED" spec/01-superlink-appliance.md
- grep "FL_DCGM_ENABLED" spec/02-supernode-appliance.md
  </verify>
  <done>spec/01-superlink-appliance.md references metrics exporter integration. spec/02-supernode-appliance.md references DCGM sidecar and updated boot sequence. spec/00-overview.md includes Phase 8 in scope, requirements, and document listing. All cross-references point to spec/13.</done>
</task>

</tasks>

<verification>
After both tasks complete, verify:
1. spec/03-contextualization-reference.md has 4 new variables with validation rules and interaction notes
2. spec/01-superlink-appliance.md references spec/13 and mentions FL_METRICS_ENABLED
3. spec/02-supernode-appliance.md references spec/13 and mentions FL_DCGM_ENABLED with boot step update
4. spec/00-overview.md includes Phase 8 in scope, lists OBS-01 and OBS-02
5. No existing variable definitions were accidentally modified (spot-check FL_GPU_ENABLED, FL_STRATEGY, FL_GRPC_KEEPALIVE_TIME still present)
6. Version numbers updated appropriately in contextualization reference
</verification>

<success_criteria>
- All 4 new Phase 8 variables (FL_LOG_FORMAT, FL_METRICS_ENABLED, FL_METRICS_PORT, FL_DCGM_ENABLED) are in spec/03 with complete definitions
- SuperLink spec references metrics exporter integration point
- SuperNode spec references DCGM sidecar integration and updated boot step count (15)
- Overview document scope includes Phase 8 and lists OBS-01, OBS-02
- Cross-references from all updated specs point to spec/13-monitoring-observability.md
- No regressions in existing spec content
</success_criteria>

<output>
After completion, create `.planning/phases/08-monitoring-and-observability/08-02-SUMMARY.md`
</output>
