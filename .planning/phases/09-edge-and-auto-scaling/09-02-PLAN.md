---
phase: 09-edge-and-auto-scaling
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - spec/03-contextualization-reference.md
  - spec/02-supernode-appliance.md
  - spec/08-single-site-orchestration.md
  - spec/00-overview.md
autonomous: true

must_haves:
  truths:
    - "The contextualization reference includes Phase 9 edge variables (FL_EDGE_BACKOFF, FL_EDGE_MAX_BACKOFF) with complete USER_INPUT definitions and validation rules"
    - "The SuperNode appliance spec references the edge variant and links to the edge spec"
    - "The orchestration spec's elasticity policies preview is replaced with a complete cross-reference to Phase 9"
    - "The overview document covers Phase 9 scope, references spec/14, and removes Phase 9 from the NOT-covered list"
  artifacts:
    - path: "spec/03-contextualization-reference.md"
      provides: "Phase 9 edge variables integrated"
      contains: "FL_EDGE_BACKOFF"
    - path: "spec/02-supernode-appliance.md"
      provides: "Edge variant cross-reference"
      contains: "spec/14-edge-and-auto-scaling"
    - path: "spec/08-single-site-orchestration.md"
      provides: "Auto-scaling cross-reference replacing preview"
      contains: "spec/14-edge-and-auto-scaling"
    - path: "spec/00-overview.md"
      provides: "Phase 9 scope and spec/14 listing"
      contains: "Edge and Auto-Scaling"
  key_links:
    - from: "spec/03-contextualization-reference.md"
      to: "spec/14-edge-and-auto-scaling.md"
      via: "Phase 9 variable definitions"
      pattern: "Phase 9"
    - from: "spec/00-overview.md"
      to: "spec/14-edge-and-auto-scaling.md"
      via: "Phase 9 spec section entry"
      pattern: "spec/14"
---

<objective>
Update four existing spec documents to integrate Phase 9 edge and auto-scaling content from spec/14-edge-and-auto-scaling.md. This follows the established cross-cutting update pattern from Phases 5-8.

Purpose: Ensures the entire specification set is internally consistent. Phase 9 variables appear in the contextualization reference, existing specs reference the new content, and the overview reflects the complete 9-phase project.

Output: Updated spec/03, spec/02, spec/08, spec/00 with Phase 9 integration.
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-edge-and-auto-scaling/09-01-SUMMARY.md

# Files to update
@spec/03-contextualization-reference.md
@spec/02-supernode-appliance.md
@spec/08-single-site-orchestration.md
@spec/00-overview.md

# New spec to reference
@spec/14-edge-and-auto-scaling.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 9 variables to contextualization reference</name>
  <files>spec/03-contextualization-reference.md</files>
  <action>
Update `spec/03-contextualization-reference.md` with Phase 9 edge variables. Follow the exact pattern established by Phase 5, 6, 7, and 8 updates:

1. **Section 1 (Purpose and Scope):**
   - Extend scope text to mention Phase 9 variables as functional for edge SuperNode variant
   - Update variable count table: SuperNode 13 -> 15 (add 2 Phase 9 vars), add Phase 9 row (2), total 46 -> 48

2. **Section 4 (SuperNode Parameters):**
   - Update header: "These 15 variables configure..." (was 13)
   - Add introductory text: "Variables #14-15 are Phase 9 (edge optimization: discovery backoff configuration for edge SuperNode variant)."
   - Add variable #14: FL_EDGE_BACKOFF
     - USER_INPUT: `O|list|Edge discovery retry backoff strategy|exponential,fixed|exponential`
     - Type: list
     - Default: exponential
     - Validation: One of: exponential, fixed. Only effective on edge SuperNode variant.
     - Flower Mapping: Discovery retry loop backoff algorithm in discover.sh
   - Add variable #15: FL_EDGE_MAX_BACKOFF
     - USER_INPUT: `O|number|Maximum backoff interval in seconds for edge discovery||300`
     - Type: number
     - Default: 300
     - Validation: Positive integer (>0). Only effective when FL_EDGE_BACKOFF=exponential.
     - Flower Mapping: Cap for exponential backoff in discovery retry loop
   - Update the SuperNode USER_INPUT Block with Phase 9 comment block and both new variables

3. **Section 8 (Validation Strategy):**
   - Add validation rules for FL_EDGE_BACKOFF (enum: exponential, fixed) and FL_EDGE_MAX_BACKOFF (positive integer)
   - Add validation entries to the validate_config() pseudocode, placed after the Phase 8 monitoring block with a Phase 9 comment header

4. **Section 10 (Parameter Interaction Notes):**
   - Add section 10o: FL_EDGE_BACKOFF and FL_EDGE_MAX_BACKOFF interaction
     - FL_EDGE_BACKOFF only affects the OneGate discovery retry loop (Step 7 of SuperNode boot), NOT Flower's runtime reconnection
     - FL_EDGE_MAX_BACKOFF is ignored when FL_EDGE_BACKOFF=fixed (fixed uses 10s interval always)
     - On standard SuperNode (non-edge QCOW2), these variables are accepted but have no visible effect (discovery uses fixed 10s interval regardless, which is equivalent to FL_EDGE_BACKOFF=fixed)
     - Cross-reference to spec/14 Section 3

5. **Appendix (Cross-Reference Matrix):**
   - Add 2 new Phase 9 rows: FL_EDGE_BACKOFF (SuperNode Y), FL_EDGE_MAX_BACKOFF (SuperNode Y)

6. **Version:** Bump 1.4 -> 1.5, update phase note to include Phase 9
  </action>
  <verify>
- grep for "FL_EDGE_BACKOFF" in spec/03 returns multiple matches (definition, validation, interaction, matrix)
- grep for "FL_EDGE_MAX_BACKOFF" in spec/03 returns multiple matches
- grep for "Phase 9" in spec/03 returns matches
- Variable count shows 48 total
- Version shows 1.5
  </verify>
  <done>Contextualization reference updated with 2 Phase 9 variables (FL_EDGE_BACKOFF, FL_EDGE_MAX_BACKOFF) including definitions, validation rules, interaction notes, and cross-reference matrix entries</done>
</task>

<task type="auto">
  <name>Task 2: Update SuperNode appliance, orchestration spec, and overview</name>
  <files>spec/02-supernode-appliance.md, spec/08-single-site-orchestration.md, spec/00-overview.md</files>
  <action>
Update three existing spec documents with Phase 9 cross-references:

**spec/02-supernode-appliance.md:**
1. Section 2 (Image Components): Add a note after the ML framework dependencies paragraph:
   "**Edge variant:** A stripped-down SuperNode QCOW2 targeting <2GB image size is specified for edge environments. The edge variant uses Ubuntu 24.04 Minimal and the base Flower image without ML framework pre-baking. See [`spec/14-edge-and-auto-scaling.md`](14-edge-and-auto-scaling.md) Section 2."
2. Section 4 (Pre-baked Image Strategy): Add to the end, before the "---" separator:
   "**Edge variant sizing:** The edge SuperNode targets <2GB by using Ubuntu Minimal (~300-400MB) and excluding ML framework Docker images. See [`spec/14-edge-and-auto-scaling.md`](14-edge-and-auto-scaling.md), Section 2 for the complete edge image size breakdown."
3. Section 6d (Discovery Retry Loop): Add a note after the "Why not exponential backoff" paragraph:
   "**Edge variant backoff:** For edge deployments with intermittent connectivity, the discovery retry loop supports configurable exponential backoff via `FL_EDGE_BACKOFF` and `FL_EDGE_MAX_BACKOFF` context variables. See [`spec/14-edge-and-auto-scaling.md`](14-edge-and-auto-scaling.md), Section 3."
4. Section 13 (SuperNode Contextualization Parameters): Add a Phase 9 subsection after the GPU Configuration Variables subsection and before the Infrastructure Variables subsection:
   "#### Edge Configuration Variables (Phase 9)"
   Add a table with FL_EDGE_BACKOFF and FL_EDGE_MAX_BACKOFF (matching the contextualization reference definitions)
5. Section 16 (Relationship to SuperLink Spec): Add a row to the cross-references table:
   - SuperNode Concept: Edge variant
   - Reference: `spec/14-edge-and-auto-scaling.md`, Section 2
   - Dependency: Edge SuperNode is a stripped-down variant; same discovery and connection model
6. Update footer phase note to include "Phase 9"

**spec/08-single-site-orchestration.md:**
1. Section 8 (Scaling Operations) - "Elasticity Policies (Preview)": Replace the entire preview subsection content. Remove the "Example structure (Phase 9 scope)" placeholder JSON and the note about Phase 9. Replace with:
   "### Elasticity Policies"
   "OneFlow supports automatic scaling of the SuperNode role via `elasticity_policies` that evaluate expression-based triggers at configurable intervals. The complete auto-scaling specification -- including expression syntax, FL-aware custom metrics, cooldown periods, and interaction with active training rounds -- is defined in [`spec/14-edge-and-auto-scaling.md`](14-edge-and-auto-scaling.md), Sections 6-9."
   "Key constraints (restated from Section 4): Elasticity policies MUST NOT be defined on the `superlink` role. `min_vms` must be >= `FL_MIN_FIT_CLIENTS` to prevent training deadlock."
2. Section 10 (Anti-Patterns): Update the "Elasticity policies on the superlink role" row's description to add: "See [`spec/14-edge-and-auto-scaling.md`](14-edge-and-auto-scaling.md), Section 10 for additional auto-scaling anti-patterns."
3. Update footer phase note to include "Phase 9" and bump version to 1.2

**spec/00-overview.md:**
1. **Phases header line:** Add "09 - Edge and Auto-Scaling"
2. **Requirements header:** Add ORCH-03, EDGE-01
3. **Section 1 (Scope):**
   - Add to "What this specification covers": "Edge optimization and auto-scaling: edge-optimized SuperNode appliance variant (<2GB), intermittent connectivity handling, OneFlow elasticity policies for dynamic client scaling (Phase 9)."
   - Remove "Edge optimization and auto-scaling (Phase 9)" from "What this specification does NOT cover" (was "deferred to later phases"). If Phase 6 is the only remaining item in NOT cover, update accordingly. Actually Phase 6 (GPU passthrough) should already be in the "covers" section since it was completed. Check and clean up the "NOT cover" list -- it should be empty now since all 9 phases are complete. Replace with: "All specification phases (1-9) are complete. No sections are deferred."
4. **Spec Sections:** Add Phase 9 table:
   "### Phase 9: Edge and Auto-Scaling"
   | Section | File | Requirement | Summary |
   | Edge and Auto-Scaling | spec/14-edge-and-auto-scaling.md | ORCH-03, EDGE-01 | Edge-optimized SuperNode appliance (<2GB QCOW2, Ubuntu Minimal, no framework pre-baked), intermittent connectivity handling, OneFlow elasticity policies, custom FL metrics for scaling triggers, client join/leave semantics. |
5. **Section 4 (Reading order):** Add Phase 9 guidance: "For edge and auto-scaling, read Phase 9 (14) which defines edge-optimized deployments and dynamic scaling rules."
6. **Section 6 (Deployment Topology):** Add an edge deployment topology preview:
   "### Edge Deployment (Phase 9)"
   ASCII diagram showing edge SuperNodes on intermittent WAN with reduced resource profile
7. **Section 9 (Phase Roadmap Reference):** The Phase 9 row should already exist. Verify it shows correct info.
8. **Version:** Bump 1.5 -> 1.6
  </action>
  <verify>
- grep for "spec/14-edge-and-auto-scaling" in spec/02 returns 3+ matches
- grep for "spec/14-edge-and-auto-scaling" in spec/08 returns 2+ matches
- grep for "spec/14-edge-and-auto-scaling" in spec/00 returns 2+ matches
- grep for "ORCH-03" in spec/00 returns match
- grep for "EDGE-01" in spec/00 returns match
- spec/00 version shows 1.6
- spec/08 version shows 1.2
- spec/00 "does NOT cover" no longer mentions edge/auto-scaling
- No regressions: grep for "FL_GPU_ENABLED" in spec/02 still returns matches
  </verify>
  <done>SuperNode appliance, orchestration spec, and overview updated with Phase 9 cross-references. All specs reference spec/14. Overview reflects complete 9-phase project. No deferred phases remain.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. spec/03 has 48 total variables, version 1.5, FL_EDGE_BACKOFF and FL_EDGE_MAX_BACKOFF fully defined
2. spec/02 cross-references spec/14 in image components, pre-baked strategy, discovery retry, and parameters sections
3. spec/08 elasticity preview replaced with complete cross-reference to spec/14
4. spec/00 covers all 9 phases, no deferred sections, version 1.6
5. No regressions in existing content (Phase 1-8 variables, cross-references intact)
6. All four roadmap success criteria verifiable from the combined spec/14 + cross-references
</verification>

<success_criteria>
1. An engineer reading spec/03 finds all 48 variables with complete definitions
2. An engineer reading spec/02 knows the edge variant exists and where to find it
3. An engineer reading spec/08 can find the auto-scaling spec from the cross-reference
4. An engineer reading spec/00 sees the complete specification project with all 9 phases covered
5. The specification project is DONE -- no sections marked as deferred or future
</success_criteria>

<output>
After completion, create `.planning/phases/09-edge-and-auto-scaling/09-02-SUMMARY.md`
</output>
