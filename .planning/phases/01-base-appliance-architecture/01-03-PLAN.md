---
phase: 01-base-appliance-architecture
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - spec/00-overview.md
  - spec/03-contextualization-reference.md
autonomous: true

must_haves:
  truths:
    - "Every Flower configuration parameter has a corresponding OpenNebula USER_INPUT variable with defined type, default value, and validation rule"
    - "The spec includes a complete contextualization variable reference table usable as an implementation checklist"
    - "A reader can deploy SuperLink + SuperNode with zero-config defaults and see federated learning running"
    - "The parameter reference distinguishes between SuperLink-only, SuperNode-only, shared, and infrastructure variables"
    - "The spec overview ties the SuperLink and SuperNode sections into a coherent whole"
  artifacts:
    - path: "spec/03-contextualization-reference.md"
      provides: "Complete contextualization variable reference table"
      contains: "## Contextualization Variable Reference"
    - path: "spec/00-overview.md"
      provides: "Spec overview tying all Phase 1 sections together"
      contains: "## Base Appliance Architecture"
  key_links:
    - from: "spec/03-contextualization-reference.md"
      to: "spec/01-superlink-appliance.md"
      via: "SuperLink parameter definitions referenced from appliance spec"
      pattern: "FL_NUM_ROUNDS|FL_STRATEGY|FL_FLEET_API_ADDRESS"
    - from: "spec/03-contextualization-reference.md"
      to: "spec/02-supernode-appliance.md"
      via: "SuperNode parameter definitions referenced from appliance spec"
      pattern: "FL_SUPERLINK_ADDRESS|FL_NODE_CONFIG|FL_MAX_RETRIES"
    - from: "spec/00-overview.md"
      to: "spec/01-superlink-appliance.md"
      via: "Section navigation"
      pattern: "01-superlink-appliance"
    - from: "spec/00-overview.md"
      to: "spec/02-supernode-appliance.md"
      via: "Section navigation"
      pattern: "02-supernode-appliance"
---

<objective>
Write the contextualization variable reference table and spec overview that ties Phase 1 together.

Purpose: This plan produces two spec artifacts. First, the complete contextualization variable reference table (APPL-03) -- the single authoritative source for every USER_INPUT variable, its type, default, validation rule, and which appliance it applies to. This is the table an engineer prints out and checks off during implementation. Second, the spec overview that introduces the Phase 1 architecture and provides navigation to the SuperLink, SuperNode, and reference sections.

Output:
- `spec/03-contextualization-reference.md` -- complete parameter reference table covering APPL-03
- `spec/00-overview.md` -- spec overview and architecture introduction
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/pablo/flower-opennebula/.planning/PROJECT.md
@/home/pablo/flower-opennebula/.planning/ROADMAP.md
@/home/pablo/flower-opennebula/.planning/STATE.md
@/home/pablo/flower-opennebula/.planning/phases/01-base-appliance-architecture/01-CONTEXT.md
@/home/pablo/flower-opennebula/.planning/phases/01-base-appliance-architecture/01-RESEARCH.md

# Read prior plan summaries for context on what was written
@/home/pablo/flower-opennebula/.planning/phases/01-base-appliance-architecture/01-01-SUMMARY.md
@/home/pablo/flower-opennebula/.planning/phases/01-base-appliance-architecture/01-02-SUMMARY.md

# Read the actual spec files to ensure consistency
@/home/pablo/flower-opennebula/spec/01-superlink-appliance.md
@/home/pablo/flower-opennebula/spec/02-supernode-appliance.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write the contextualization variable reference table</name>
  <files>spec/03-contextualization-reference.md</files>
  <action>
Write `spec/03-contextualization-reference.md` as the authoritative contextualization parameter reference for both appliances. This is a SPEC DOCUMENT that an engineer uses as an implementation checklist.

The spec section MUST cover these areas:

**1. Purpose and Scope**
- This section is the single source of truth for all OpenNebula contextualization variables used by the Flower appliances
- Each variable maps to a Flower CLI flag or infrastructure configuration
- Variables use the OpenNebula USER_INPUTS pipe-delimited format
- Zero-config defaults: deploying both appliances with no custom parameters produces a working FL setup

**2. USER_INPUT Format Reference**
Document the OpenNebula USER_INPUT syntax for implementers:
- Format: `VARIABLE_NAME="M|type|Description|options|default"` (or `O` for optional)
- Supported types relevant to Flower appliances: text, number, list, boolean, text64, range, fixed
- Include a brief example for each type used

**3. SuperLink Parameters Table**
Complete table with columns: Variable Name, USER_INPUT Definition, Flower CLI Flag/Config, Default Value, Validation Rule, Description

Variables (from research, all optional for zero-config):
| Variable | USER_INPUT | Maps To | Default | Validation | Description |
|----------|-----------|---------|---------|------------|-------------|
| FLOWER_VERSION | O\|text\|Flower Docker image version tag\|\|1.25.0 | Docker image tag | 1.25.0 | Non-empty string, valid Docker tag format | Flower container version |
| FL_NUM_ROUNDS | O\|number\|Number of federated learning rounds\|\|3 | ServerApp config | 3 | Positive integer >= 1 | Training rounds to execute |
| FL_STRATEGY | O\|list\|Aggregation strategy\|FedAvg,FedProx,FedAdam\|FedAvg | ServerApp config | FedAvg | Must be one of: FedAvg, FedProx, FedAdam | How model updates are aggregated |
| FL_MIN_FIT_CLIENTS | O\|number\|Minimum clients for training round\|\|2 | ServerApp config | 2 | Positive integer >= 1 | Min clients before starting fit round |
| FL_MIN_EVALUATE_CLIENTS | O\|number\|Minimum clients for evaluation\|\|2 | ServerApp config | 2 | Positive integer >= 1 | Min clients for evaluation round |
| FL_MIN_AVAILABLE_CLIENTS | O\|number\|Minimum available clients to start\|\|2 | ServerApp config | 2 | Positive integer >= 1 | Min connected clients before any round |
| FL_FLEET_API_ADDRESS | O\|text\|Fleet API listen address\|\|0.0.0.0:9092 | --fleet-api-address | 0.0.0.0:9092 | Valid host:port format | SuperNode connection endpoint |
| FL_CONTROL_API_ADDRESS | O\|text\|Control API listen address\|\|0.0.0.0:9093 | --control-api-address | 0.0.0.0:9093 | Valid host:port format | CLI management endpoint |
| FL_ISOLATION | O\|list\|App execution isolation mode\|subprocess,process\|subprocess | --isolation | subprocess | Must be: subprocess or process | How app processes are managed |
| FL_DATABASE | O\|text\|Database path for state persistence\|\|state/state.db | --database | state/state.db | Valid file path | SQLite DB for run history |
| FL_LOG_LEVEL | O\|list\|Log verbosity\|DEBUG,INFO,WARNING,ERROR\|INFO | FLWR_LOG_LEVEL env | INFO | Must be: DEBUG, INFO, WARNING, ERROR | Container log verbosity |

**4. SuperNode Parameters Table**
Same format:
| Variable | USER_INPUT | Maps To | Default | Validation | Description |
|----------|-----------|---------|---------|------------|-------------|
| FLOWER_VERSION | O\|text\|Flower Docker image version tag\|\|1.25.0 | Docker image tag | 1.25.0 | Same as SuperLink | Must match SuperLink version |
| FL_SUPERLINK_ADDRESS | O\|text\|SuperLink Fleet API address (host:port)\|\| | --superlink | (empty) | Valid host:port or empty | Empty triggers OneGate discovery |
| FL_NODE_CONFIG | O\|text\|Space-separated key=value node config\|\| | --node-config | (empty) | Key=value pairs separated by spaces | Passed to ClientApp (e.g., partition-id=0) |
| FL_MAX_RETRIES | O\|number\|Max reconnection attempts (0=unlimited)\|\|0 | --max-retries | 0 | Non-negative integer | 0 means unlimited retries |
| FL_MAX_WAIT_TIME | O\|number\|Max wait time for connection (0=unlimited)\|\|0 | --max-wait-time | 0 | Non-negative integer (seconds) | 0 means no timeout |
| FL_ISOLATION | O\|list\|App execution isolation mode\|subprocess,process\|subprocess | --isolation | subprocess | Same as SuperLink | Same setting on both sides |
| FL_LOG_LEVEL | O\|list\|Log verbosity\|DEBUG,INFO,WARNING,ERROR\|INFO | FLWR_LOG_LEVEL env | INFO | Same as SuperLink | Container log verbosity |

**5. Shared Infrastructure Parameters Table**
Variables set automatically or by the VM template (not user-facing in the Flower appliance sense):
| Variable | Set By | Purpose | Value | Notes |
|----------|--------|---------|-------|-------|
| TOKEN | VM Template | OneGate authentication | YES | Required for dynamic discovery |
| NETWORK | VM Template | Network configuration | YES | Required for IP assignment |
| REPORT_READY | VM Template | Readiness reporting | YES | Reports after health check passes |
| READY_SCRIPT_PATH | VM Template | Health check script | /opt/flower/scripts/health-check.sh | Must return 0 for READY |
| SSH_PUBLIC_KEY | User/Template | SSH access | $USER[SSH_PUBLIC_KEY] | Standard OpenNebula pattern |

**6. Phase 2+ Placeholder Parameters**
Variables defined in the parameter space but NOT functional in Phase 1:
| Variable | Phase | USER_INPUT | Default | Purpose |
|----------|-------|-----------|---------|---------|
| FL_TLS_ENABLED | 2 | O\|boolean\|Enable TLS encryption\|\|NO | NO | Master TLS switch |
| FL_SSL_CA_CERTFILE | 2 | O\|text64\|CA certificate (base64 PEM) | (empty) | CA cert for verification |
| FL_SSL_CERTFILE | 2 | O\|text64\|Server certificate (base64 PEM) | (empty) | SuperLink server cert |
| FL_SSL_KEYFILE | 2 | O\|text64\|Server private key (base64 PEM) | (empty) | SuperLink private key |
| FL_GPU_ENABLED | 6 | O\|boolean\|Enable NVIDIA GPU support\|\|NO | NO | GPU passthrough |
| ML_FRAMEWORK | 3 | O\|list\|ML framework\|pytorch,tensorflow,sklearn\|pytorch | pytorch | Framework variant |

Mark these clearly as "RESERVED -- not implemented in Phase 1."

**7. Naming Convention Rationale**
- `FLOWER_VERSION`: OpenNebula marketplace convention (PRODUCT_FIELD)
- `FL_*` prefix: Flower-specific config, short, distinctive, avoids collision
- Uppercase with underscores: standard OpenNebula CONTEXT variable style
- No underscores in values, only in variable names

**8. Validation Strategy**
Specify the fail-fast validation approach:
- All validation happens in configure.sh before Docker container starts
- Invalid values produce clear error messages with the variable name and expected format
- Validation failures prevent container startup and prevent REPORT_READY
- Include the validation pseudocode from research (validate_config function)
- Special validation: SuperNode must have either FL_SUPERLINK_ADDRESS or OneGate token available

**9. Zero-Config Deployment Scenario**
Walk through what happens when a user deploys both appliances with ALL defaults:
- SuperLink: runs FedAvg strategy, 3 rounds, listens on 0.0.0.0:9092, subprocess isolation, insecure mode
- SuperNode: discovers SuperLink via OneGate (if OneFlow deployment) or needs FL_SUPERLINK_ADDRESS for standalone
- Result: a functional federated learning setup ready for a training task
- Note: zero-config requires at least 2 SuperNodes to satisfy default min_fit_clients=2

**10. Parameter Interaction Notes**
Document important parameter interactions:
- FLOWER_VERSION must match across SuperLink and SuperNode (mismatch causes gRPC errors)
- FL_MIN_FIT_CLIENTS must be <= number of deployed SuperNodes (otherwise training rounds never start)
- FL_ISOLATION should be the same on both sides (mixing subprocess/process is untested)
- FL_SUPERLINK_ADDRESS empty + no OneGate = SuperNode fails to boot (documented error)
  </action>
  <verify>
- `ls -la /home/pablo/flower-opennebula/spec/03-contextualization-reference.md` (file exists)
- Check the file contains all 11 SuperLink variables with USER_INPUT definitions
- Check the file contains all 7 SuperNode variables with USER_INPUT definitions
- Check the file contains shared infrastructure variables (TOKEN, NETWORK, REPORT_READY, etc.)
- Check the file contains Phase 2+ placeholder variables
- Check the file includes validation rules for each variable
- Check the file documents the zero-config deployment scenario
- Check the file documents parameter interaction warnings
  </verify>
  <done>
`spec/03-contextualization-reference.md` exists and:
1. Every Flower parameter has a USER_INPUT definition with type, default, and validation rule
2. An engineer can use this as a checklist to implement contextualization
3. Zero-config defaults are documented with the expected outcome
4. Parameter interactions and compatibility warnings are documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Write the spec overview document</name>
  <files>spec/00-overview.md</files>
  <action>
Write `spec/00-overview.md` as the introduction and navigation document for the Phase 1 spec. This ties the three spec sections together and provides the architectural big picture.

The overview MUST cover:

**1. Title and Scope**
- Title: "Base Appliance Architecture -- Technical Specification"
- Scope: SuperLink and SuperNode marketplace appliances for Flower federated learning on OpenNebula
- What this spec covers: appliance packaging, boot sequences, contextualization parameters
- What this spec does NOT cover: TLS/security (Phase 2), ML framework variants (Phase 3), orchestration (Phase 4)

**2. Architecture Diagram (ASCII)**
Create an ASCII diagram showing the high-level architecture:
```
+--------------------+          +--------------------+
| SuperLink VM       |          | SuperNode VM       |
|                    |          |                    |
| +----------------+ |  gRPC    | +----------------+ |
| | flwr/superlink | |<---------| | flwr/supernode | |
| | (Docker)       | | :9092    | | (Docker)       | |
| +----------------+ |          | +----------------+ |
|                    |          |                    |
| Ubuntu 24.04 LTS   |          | Ubuntu 24.04 LTS   |
| Docker CE 24+      |          | Docker CE 24+      |
+--------------------+          +--------------------+
         |                               |
         |  OneGate (FL_ENDPOINT)         |  OneGate (discovery)
         v                               v
+------------------------------------------------+
|            OpenNebula Platform                  |
|  OneGate | OneFlow | Marketplace | Contextualization |
+------------------------------------------------+
```

**3. Design Principles**
List the key design principles that guided the spec:
- Docker-in-VM: one Flower container per VM, managed by systemd
- Pre-baked images: self-contained QCOW2 for edge/air-gapped environments
- Zero-config defaults: deploy and run with no parameter changes
- Immutable appliances: redeploy to change configuration
- OneGate-first discovery: dynamic by default, static override available
- Fail-fast validation: catch config errors before container starts
- Defense in depth: boot script discovery + Flower-native reconnection

**4. Spec Sections**
Navigation guide to the three sections:
- Section 01: SuperLink Appliance (`01-superlink-appliance.md`) -- FL coordinator, aggregation server
- Section 02: SuperNode Appliance (`02-supernode-appliance.md`) -- FL client, local trainer
- Section 03: Contextualization Reference (`03-contextualization-reference.md`) -- complete parameter tables

**5. Technology Stack Summary**
Quick reference table:
| Component | Technology | Version |
|-----------|-----------|---------|
| VM Base OS | Ubuntu 24.04 LTS | 24.04 |
| Container Runtime | Docker CE | 24+ |
| FL Coordinator | flwr/superlink | 1.25.0 |
| FL Client | flwr/supernode | 1.25.0 |
| Platform | OpenNebula | 7.0+ |
| Guest Integration | one-apps contextualization | latest |

**6. Deployment Topology**
Describe the minimal deployment:
- 1 SuperLink VM (coordinator)
- N SuperNode VMs (clients, minimum 2 for default config)
- OneFlow manages deployment ordering (SuperLink first, then SuperNodes)
- OneGate provides runtime service discovery

**7. Open Questions and Assumptions**
Consolidate from research. Key items:
- REPORT_READY + OneFlow interaction timing (needs validation)
- OneGate GET /service exact JSON path (needs validation during implementation)
- Flower --health-server-address behavior (sparse docs, using TCP check instead)
- OneFlow parent attribute reference timing for dynamic IPs (using OneGate as primary mechanism)

**8. Phase Roadmap Reference**
Brief note on what comes next:
- Phase 2: TLS certificate automation (replaces --insecure)
- Phase 3: ML framework variant images
- Phase 4: OneFlow service template
- (Full roadmap in project planning docs)

Keep this document concise (aim for 150-250 lines). It is a navigation aid and architectural overview, not a specification itself.
  </action>
  <verify>
- `ls -la /home/pablo/flower-opennebula/spec/00-overview.md` (file exists)
- Check the file contains an architecture diagram
- Check the file references all three spec sections by filename
- Check the file includes the technology stack summary
- Check the file documents open questions
- Check the file stays within scope (no TLS, no orchestration details)
  </verify>
  <done>
`spec/00-overview.md` exists and:
1. Provides an architectural overview with ASCII diagram
2. Lists design principles that guided all three spec sections
3. Navigates readers to the correct section for their need
4. Documents open questions and assumptions for implementers
  </done>
</task>

</tasks>

<verification>
- All four spec files exist in /home/pablo/flower-opennebula/spec/
- The contextualization reference covers ALL variables from both appliance specs
- The overview ties all sections together with consistent terminology
- Zero-config deployment scenario is documented end-to-end
- APPL-03 requirement is fully satisfied (every Flower param mapped to USER_INPUT with type, default, validation)
- Parameter tables are formatted as tables, not prose (implementer-friendly)
</verification>

<success_criteria>
- `spec/00-overview.md` provides architectural context and navigation
- `spec/03-contextualization-reference.md` is the authoritative parameter reference
- Together with Plans 01+02 outputs, the complete Phase 1 spec satisfies all four success criteria from the roadmap:
  1. SuperLink components and boot sequence (Plan 01)
  2. SuperNode components and discovery/connection (Plan 02)
  3. Every parameter mapped to USER_INPUT (Plan 03)
  4. Complete reference table for implementation (Plan 03)
- An engineer can implement both appliances using only these spec documents
</success_criteria>

<output>
After completion, create `.planning/phases/01-base-appliance-architecture/01-03-SUMMARY.md`
</output>
