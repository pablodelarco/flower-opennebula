---
phase: 02-security-and-certificate-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spec/04-tls-certificate-lifecycle.md
autonomous: true

must_haves:
  truths:
    - "A reader can identify the exact certificate generation sequence on the SuperLink: CA key, CA cert, server key, CSR, signed server cert"
    - "A reader can identify file paths, ownership (UID 49999), and permissions (0600 for keys, 0644 for certs) for every certificate artifact"
    - "A reader can determine how the SuperLink publishes the CA certificate to OneGate (base64-encoded, FL_CA_CERT attribute)"
    - "A reader can follow both certificate provisioning paths: auto-generation (default) and operator-provided (FL_SSL_* CONTEXT variables)"
    - "A reader can see the updated SuperLink Docker run command with --ssl-ca-certfile, --ssl-certfile, --ssl-keyfile flags replacing --insecure"
  artifacts:
    - path: "spec/04-tls-certificate-lifecycle.md"
      provides: "TLS certificate generation, file layout, boot sequence changes, dual provisioning model, OneGate publication for SuperLink"
      contains: "Certificate Generation Sequence"
  key_links:
    - from: "spec/04-tls-certificate-lifecycle.md"
      to: "spec/01-superlink-appliance.md"
      via: "Boot sequence step 7a insertion, OneGate publication extension, Docker run command update"
      pattern: "Step 7a.*TLS Certificate"
    - from: "spec/04-tls-certificate-lifecycle.md"
      to: "spec/03-contextualization-reference.md"
      via: "New FL_TLS_ENABLED, FL_SSL_CA_CERTFILE, FL_SSL_CERTFILE, FL_SSL_KEYFILE variables"
      pattern: "FL_TLS_ENABLED"
---

<objective>
Write the TLS certificate lifecycle specification section covering the SuperLink side: certificate generation at boot, file layout and permissions, dual provisioning model (auto-gen vs operator-provided), SuperLink boot sequence modifications, updated Docker run command, and OneGate publication of the CA certificate.

Purpose: This is the server-side half of APPL-04. It defines how TLS certificates come into existence on the SuperLink and how the CA certificate is made available for SuperNode retrieval. Without this, Phase 2's trust chain has no root.

Output: `spec/04-tls-certificate-lifecycle.md` -- the TLS security specification section for the integration spec.
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-and-certificate-automation/02-RESEARCH.md
@spec/01-superlink-appliance.md
@spec/03-contextualization-reference.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write TLS certificate lifecycle spec section (SuperLink focus)</name>
  <files>spec/04-tls-certificate-lifecycle.md</files>
  <action>
Create `spec/04-tls-certificate-lifecycle.md` as a new spec section following the same format as existing spec files (numbered sections, markdown tables, code blocks with annotations).

The spec section MUST cover these areas, in this order:

**1. TLS Security Overview**
- Flower uses server-side TLS (NOT mutual TLS / mTLS). SuperLink proves its identity to SuperNodes; SuperNodes do not present client certificates.
- Three files on SuperLink: CA cert (`ca.crt`), server cert (`server.pem`), server key (`server.key`). One file on SuperNode: CA cert (`ca.crt`).
- `FL_TLS_ENABLED=YES` is the master switch. When `NO` (default), Phase 1 `--insecure` behavior applies.
- Flower has a separate SuperNode authentication layer (ECDSA-based, sits on top of TLS) that is out of scope for APPL-04.
- Reference the trust chain diagram from research: Self-signed CA -> signs server cert (with VM IP as SAN) -> CA cert distributed to SuperNodes.

**2. Certificate File Layout**
- Host paths: `/opt/flower/certs/` directory (already exists from Phase 1, owned by 49999:49999, mode 0700).
- Files: `ca.key` (root:root, 0600 -- NOT mounted into container), `ca.crt` (49999:49999, 0644), `server.pem` (49999:49999, 0644), `server.key` (49999:49999, 0600).
- Container mount: `-v /opt/flower/certs:/app/certificates:ro` for SuperLink.
- Container paths: `/app/certificates/ca.crt`, `/app/certificates/server.pem`, `/app/certificates/server.key`.
- Include a file layout diagram similar to Phase 1 spec style.

**3. Certificate Generation Sequence**
- Full OpenSSL command sequence from research (Pattern 2):
  1. Generate CA private key (RSA 4096-bit)
  2. Generate self-signed CA certificate (365-day validity, `/O=Flower FL/CN=Flower CA`)
  3. Generate server private key (RSA 4096-bit)
  4. Generate server CSR with dynamic SAN (VM IP detected via `hostname -I | awk '{print $1}'`)
  5. Sign server certificate with CA (365 days, SHA-256)
  6. Clean up CSR and serial files
  7. Set ownership and permissions (chown 49999:49999, chmod per table above)
  8. Verify chain: `openssl verify -CAfile ca.crt server.pem`
- Include the complete generation script from research as a specification (this is what the implementation script MUST do, not reference code).
- SAN configuration MUST include: DNS.1=localhost, IP.1=127.0.0.1, IP.2=::1, IP.3=${VM_IP}.
- Certificate validity: 365 days. Document this as a known constraint -- redeploy to renew. FL training campaigns are hours to weeks, not years.
- CA key retention: Retained on SuperLink with root:root 0600 permissions. NOT mounted into container. May be needed for Phase 7 cross-zone cert signing.

**4. Dual Provisioning Model**
- Auto-generation (default): When `FL_TLS_ENABLED=YES` and no `FL_SSL_CA_CERTFILE` is provided, generate certificates at boot.
- Operator-provided: When `FL_SSL_CA_CERTFILE`, `FL_SSL_CERTFILE`, and `FL_SSL_KEYFILE` are all set (base64-encoded PEM via `text64` type), decode them to `/opt/flower/certs/` and skip generation. All three must be provided together (all or none rule).
- Decision flowchart (from research Pattern 4): FL_TLS_ENABLED check -> FL_SSL_CA_CERTFILE check -> auto-gen or decode.
- Validation of operator-provided certs: `openssl verify -CAfile ca.crt server.pem` after decoding.
- Include the decode function spec from research.

**5. SuperLink Boot Sequence Modification**
- Reference the Phase 1 12-step boot sequence from `spec/01-superlink-appliance.md`.
- Insert new Step 7a: "TLS Certificate Setup" between existing Steps 7 (config validation) and 8 (generate systemd unit).
- Step 7a specification: IF FL_TLS_ENABLED=YES -> determine provisioning path -> generate or decode -> validate chain -> set ownership.
- If FL_TLS_ENABLED is not YES, skip Step 7a entirely (Phase 1 behavior preserved).
- Updated Step 8: Systemd unit and Docker run command conditionally include TLS flags.
- Updated Step 12: OneGate publication adds FL_TLS and FL_CA_CERT attributes.
- Present this as a delta to the Phase 1 boot sequence, not a full rewrite. Use "UPDATED" and "NEW" markers.

**6. SuperLink Docker Run Command (TLS Mode)**
- Full `docker run` command with TLS flags (from research):
  - Remove `--insecure`
  - Add `-v /opt/flower/certs:/app/certificates:ro`
  - Add `--ssl-ca-certfile certificates/ca.crt`
  - Add `--ssl-certfile certificates/server.pem`
  - Add `--ssl-keyfile certificates/server.key`
- Show both the insecure (Phase 1, for reference) and TLS mode commands side by side for clarity.
- Note: The Flower `--ssl-*` flags use legacy "SSL" naming but the actual protocol is TLS 1.2+.

**7. OneGate Publication Extension**
- Two new attributes added to the existing OneGate publication (extending Section 10 of SuperLink spec):
  - `FL_TLS`: `YES` or `NO` -- whether SuperLink is running with TLS
  - `FL_CA_CERT`: base64-encoded PEM CA certificate (using `base64 -w0` for single-line output)
- Updated publication command showing all attributes (existing FL_READY, FL_ENDPOINT, FL_VERSION, FL_ROLE + new FL_TLS, FL_CA_CERT).
- Security note: ONLY `ca.crt` is published. NEVER `ca.key`, `server.key`, or `server.pem`. Include explicit anti-pattern warning.

**8. New Contextualization Variables (SuperLink)**
- `FL_TLS_ENABLED`: `O|boolean`, default `NO`, both appliances. Master switch for TLS mode.
- `FL_SSL_CA_CERTFILE`: `O|text64`, no default, both appliances. Base64-encoded PEM CA certificate.
- `FL_SSL_CERTFILE`: `O|text64`, no default, SuperLink only. Base64-encoded PEM server certificate.
- `FL_SSL_KEYFILE`: `O|text64`, no default, SuperLink only. Base64-encoded PEM server private key.
- Include USER_INPUT definitions in the same format as Phase 1 spec.
- Validation rules: FL_TLS_ENABLED must be YES or NO; FL_SSL_* must decode to valid PEM; all three FL_SSL_* must be provided together on SuperLink.
- Consistency rule: If FL_TLS_ENABLED=YES on SuperLink, ALL SuperNodes MUST have TLS enabled.
- Note: These variables were listed as "Phase 2 placeholders" in Phase 1 spec. This section makes them fully specified.

**9. Failure Modes**
- Certificate generation failure (openssl command fails): Fatal, boot aborts.
- Chain verification failure (openssl verify fails): Fatal, boot aborts with clear error.
- Operator-provided cert decode failure (invalid base64 or PEM): Fatal, boot aborts.
- Missing FL_SSL_CERTFILE/FL_SSL_KEYFILE when FL_SSL_CA_CERTFILE is set: Fatal, validation error.
- OneGate FL_CA_CERT publication failure: Non-blocking warning (same as FL_READY -- best-effort).
- Certificate expiry (365 days): Runtime, documented constraint. Redeploy to renew.
- Include these in a failure modes table following the Phase 1 format.

**10. Security Considerations**
- Private keys (ca.key, server.key) MUST never leave the SuperLink VM.
- ca.key is NOT mounted into the Docker container.
- server.key is mounted read-only with 0600 permissions.
- OneGate publication MUST explicitly name only ca.crt. No glob patterns.
- Base64 encoding preserves PEM structure through OneGate's XML transport.
- Document that self-signed CA is appropriate for marketplace appliances. Operators with PKI infrastructure use the manual provisioning path.

Include a "Relationship to Other Spec Sections" appendix (same pattern as Phase 1 specs) showing how this section connects to 01-superlink-appliance.md, 02-supernode-appliance.md, 03-contextualization-reference.md, and future Phase 4/7 sections.
  </action>
  <verify>
1. File exists at `spec/04-tls-certificate-lifecycle.md`
2. File contains all 10 numbered sections
3. Certificate generation sequence includes all 8 OpenSSL steps
4. Dual provisioning flowchart covers both auto-gen and operator-provided paths
5. Boot sequence modification references Phase 1 steps by number
6. Docker run command includes all three --ssl-* flags
7. OneGate publication shows FL_TLS and FL_CA_CERT attributes
8. USER_INPUT definitions present for all 4 new variables
9. Failure modes table present with severity classification
10. No private keys (ca.key, server.key) appear in any OneGate publication or distribution command
  </verify>
  <done>
The spec section fully defines the SuperLink-side TLS certificate lifecycle: a reader can follow the complete path from FL_TLS_ENABLED=YES through certificate generation (or decode), file layout with correct permissions, Docker container TLS configuration, and OneGate CA certificate publication. Both auto-generated and operator-provided certificate paths are specified with clear decision logic.
  </done>
</task>

</tasks>

<verification>
Phase-level verification for Plan 02-01:
- Read through `spec/04-tls-certificate-lifecycle.md` and confirm it satisfies Phase 2 success criteria #1 (exact certificate generation sequence with CA creation, server cert signing, file paths, ownership to UID 49999)
- Confirm the OneGate publication contract (FL_TLS, FL_CA_CERT) is defined clearly enough for Plan 02-02 to reference
- Confirm no private key material appears in any distribution or publication specification
</verification>

<success_criteria>
- `spec/04-tls-certificate-lifecycle.md` exists with 10 sections covering generation, provisioning, boot sequence, Docker, OneGate, variables, failures, and security
- Certificate generation sequence specifies exact OpenSSL commands with RSA 4096-bit keys, 365-day validity, and dynamic SAN including VM IP
- Dual provisioning model has clear decision logic: FL_TLS_ENABLED -> FL_SSL_CA_CERTFILE -> auto-gen or decode
- OneGate publication adds FL_TLS and FL_CA_CERT (base64 ca.crt only) to existing contract
- Four new USER_INPUT variables defined with types, defaults, and validation rules
- Boot sequence changes presented as delta to Phase 1 (Step 7a insertion, Step 8/12 updates)
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-and-certificate-automation/02-01-SUMMARY.md`
</output>
