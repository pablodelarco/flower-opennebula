---
phase: 02-security-and-certificate-automation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - spec/05-supernode-tls-trust.md
autonomous: true

must_haves:
  truths:
    - "A reader can trace the complete path: SuperNode boots -> discovers SuperLink via OneGate -> detects FL_TLS=YES -> retrieves FL_CA_CERT -> decodes to ca.crt -> starts container with --root-certificates"
    - "A reader can identify both CA certificate acquisition paths: OneGate retrieval (auto, default) and CONTEXT variable provisioning (static, for non-OneFlow deployments)"
    - "A reader can follow the end-to-end TLS handshake: SuperNode presents no client cert, SuperLink presents server cert signed by CA, SuperNode verifies server cert against CA cert"
    - "A reader can see the updated SuperNode Docker run command with --root-certificates replacing --insecure"
    - "A reader can deploy a TLS-secured Flower cluster using only the spec: SuperLink generates certs, publishes CA to OneGate, SuperNodes retrieve and trust it"
  artifacts:
    - path: "spec/05-supernode-tls-trust.md"
      provides: "SuperNode CA certificate retrieval, TLS mode detection, boot sequence changes, Docker run update, end-to-end handshake walkthrough"
      contains: "End-to-End TLS Handshake"
  key_links:
    - from: "spec/05-supernode-tls-trust.md"
      to: "spec/04-tls-certificate-lifecycle.md"
      via: "References OneGate FL_TLS and FL_CA_CERT attributes published by SuperLink"
      pattern: "FL_CA_CERT"
    - from: "spec/05-supernode-tls-trust.md"
      to: "spec/02-supernode-appliance.md"
      via: "Boot sequence step 7 update, step 7b insertion, step 10 Docker run update"
      pattern: "Step 7.*discovery.*UPDATED"
    - from: "spec/05-supernode-tls-trust.md"
      to: "spec/03-contextualization-reference.md"
      via: "FL_TLS_ENABLED and FL_SSL_CA_CERTFILE now fully specified for SuperNode"
      pattern: "FL_TLS_ENABLED"
---

<objective>
Write the SuperNode TLS trust specification covering CA certificate retrieval from OneGate, static certificate provisioning fallback, TLS mode detection, SuperNode boot sequence modifications, updated Docker run command, and a complete end-to-end TLS handshake walkthrough from SuperNode boot to authenticated gRPC connection.

Purpose: This completes the client-side half of APPL-04. Combined with Plan 02-01 (SuperLink TLS lifecycle), a reader can trace the complete trust chain from certificate generation through distribution to verified connection. This section also provides the end-to-end walkthrough that satisfies Phase 2 success criterion #3.

Output: `spec/05-supernode-tls-trust.md` -- the SuperNode TLS trust and end-to-end handshake specification section.
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-and-certificate-automation/02-RESEARCH.md
@.planning/phases/02-security-and-certificate-automation/02-01-SUMMARY.md
@spec/02-supernode-appliance.md
@spec/04-tls-certificate-lifecycle.md
@spec/03-contextualization-reference.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write SuperNode TLS trust spec section</name>
  <files>spec/05-supernode-tls-trust.md</files>
  <action>
Create `spec/05-supernode-tls-trust.md` as a new spec section following the same format as existing spec files.

The spec section MUST cover these areas, in this order:

**1. SuperNode TLS Trust Model**
- SuperNode role in server-side TLS: it verifies the SuperLink's identity using the CA certificate. It does NOT present a client certificate.
- Single file needed on SuperNode: `ca.crt` (the CA certificate that signed the SuperLink's server certificate).
- Two acquisition paths: OneGate retrieval (default, automatic) and CONTEXT variable provisioning (manual, for static/non-OneFlow deployments).
- Reference `spec/04-tls-certificate-lifecycle.md` for the server-side certificate generation and OneGate publication.

**2. CA Certificate Retrieval from OneGate**
- During the existing discovery phase (Step 7 of the SuperNode boot sequence), after discovering `FL_ENDPOINT`, also check for `FL_TLS` and `FL_CA_CERT` attributes.
- jq extraction path: `.SERVICE.roles[] | select(.name == "superlink") | .nodes[0].vm_info.VM.USER_TEMPLATE.FL_TLS` and `.FL_CA_CERT`.
- If `FL_TLS` is `YES` and `FL_CA_CERT` is present: decode from base64, write to `/opt/flower/certs/ca.crt`, set ownership to 49999:49999.
- If `FL_TLS` is `YES` but `FL_CA_CERT` is missing: FATAL error -- SuperLink claims TLS but did not publish CA cert. Log clear error message.
- If `FL_TLS` is not `YES` or not present: no certificate needed, proceed with `--insecure` mode.
- Include the retrieval function spec from research (retrieve_ca_cert).

**3. Static CA Certificate Provisioning**
- For SuperNodes deployed outside OneFlow (no OneGate service context) or with static `FL_SUPERLINK_ADDRESS`:
  - `FL_TLS_ENABLED=YES` must be set explicitly in CONTEXT.
  - `FL_SSL_CA_CERTFILE` must contain the base64-encoded PEM CA certificate.
  - The configure script decodes it to `/opt/flower/certs/ca.crt`, sets ownership.
- Decision logic: IF FL_SUPERLINK_ADDRESS is set (static mode) AND FL_TLS_ENABLED=YES -> FL_SSL_CA_CERTFILE is REQUIRED. If missing, FATAL error.
- This path also works for operators who want to use their own CA certificate even in OneFlow deployments (overrides OneGate retrieval).

**4. TLS Mode Detection Logic**
- The SuperNode must determine its TLS mode before starting the container. Present a clear decision flowchart:
  1. Check `FL_TLS_ENABLED` CONTEXT variable. If `YES` -> TLS mode forced on.
  2. If `FL_TLS_ENABLED` is not set or `NO` -> check OneGate discovery response for `FL_TLS` attribute.
  3. If OneGate `FL_TLS=YES` -> TLS mode auto-detected.
  4. If neither -> insecure mode (Phase 1 behavior).
- Priority: Explicit CONTEXT (`FL_TLS_ENABLED=YES`) > OneGate auto-detection (`FL_TLS=YES`) > insecure default.
- This means a SuperNode with `FL_TLS_ENABLED=NO` explicitly set will NOT use TLS even if the SuperLink advertises it (mismatch will cause connection failure -- document this as an operator error).

**5. Certificate Validation on SuperNode**
- After acquiring CA cert (from either path), validate it: `openssl x509 -in /opt/flower/certs/ca.crt -noout`.
- If validation fails: FATAL error, boot aborts. Log: "CA certificate is invalid PEM format. Check FL_SSL_CA_CERTFILE or SuperLink's FL_CA_CERT publication."
- No chain verification on SuperNode (it only has the CA cert, not the server cert). Chain verification happens at TLS handshake time.

**6. SuperNode Boot Sequence Modification**
- Reference the Phase 1 13-step boot sequence from `spec/02-supernode-appliance.md`.
- Step 7 (discovery) UPDATED: After discovering FL_ENDPOINT, also extract FL_TLS and FL_CA_CERT. Set TLS mode flag based on detection logic.
- NEW Step 7b: "TLS Certificate Validation" -- validate the CA cert if TLS mode is active.
- Step 10 (container start) UPDATED: Conditionally modify Docker run command based on TLS mode.
- Present as delta to Phase 1 sequence with UPDATED and NEW markers.

**7. SuperNode Docker Run Command (TLS Mode)**
- Full `docker run` command with TLS (from research):
  - Remove `--insecure`
  - Add `-v /opt/flower/certs/ca.crt:/app/ca.crt:ro` (single file mount, not directory)
  - Add `--root-certificates ca.crt`
- Show both insecure (Phase 1) and TLS commands side by side.
- Note: Single file mount (`ca.crt:/app/ca.crt:ro`) not directory mount. SuperNode only needs the CA cert.

**8. End-to-End TLS Handshake Walkthrough**
THIS IS THE KEY SECTION for Phase 2 success criterion #3. Walk through the complete flow step by step:

1. SuperLink boots -> FL_TLS_ENABLED=YES -> Step 7a generates self-signed CA + server cert -> sets ownership -> validates chain
2. SuperLink starts container with --ssl-ca-certfile, --ssl-certfile, --ssl-keyfile -> Flower's gRPC server loads certificates
3. SuperLink publishes FL_READY=YES, FL_ENDPOINT, FL_TLS=YES, FL_CA_CERT=(base64 ca.crt) to OneGate
4. SuperNode boots -> Step 7 discovers SuperLink endpoint and FL_TLS=YES -> retrieves FL_CA_CERT -> decodes to /opt/flower/certs/ca.crt
5. SuperNode Step 7b validates CA cert format
6. SuperNode starts container with --root-certificates ca.crt -> Flower's gRPC client loads CA cert
7. gRPC TLS handshake: SuperNode connects to SuperLink:9092 -> SuperLink presents server.pem -> SuperNode verifies server.pem was signed by ca.crt AND server cert SAN matches the connection IP -> handshake succeeds
8. gRPC channel is encrypted (TLS 1.2+). Model weights and gradients transit encrypted. Data never leaves the SuperNode.
9. If SAN mismatch: handshake fails with "certificate verify failed". Cause: SuperLink IP changed since cert generation, or SuperNode connecting to wrong IP.

Include a sequence diagram (ASCII art) showing the temporal flow: SuperLink boot -> cert gen -> OneGate publish -> SuperNode boot -> cert retrieve -> TLS connect.

**9. SuperNode Contextualization Variable Updates**
- `FL_TLS_ENABLED` and `FL_SSL_CA_CERTFILE` are the only TLS variables relevant to SuperNode (the three FL_SSL_*FILE vars for server cert/key are SuperLink-only).
- Update the Phase 1 "Phase 2+ Placeholder Variables" section from spec/02-supernode-appliance.md -- these are now fully specified.
- Include USER_INPUT definitions.
- Validation: FL_TLS_ENABLED is YES/NO; FL_SSL_CA_CERTFILE must decode to valid PEM if set.
- Consistency: If using static discovery (FL_SUPERLINK_ADDRESS set) with TLS, FL_SSL_CA_CERTFILE is required.

**10. Failure Modes**
- FL_TLS=YES on SuperLink but FL_CA_CERT missing from OneGate: Fatal, clear error.
- Invalid CA cert (base64 decode fails or PEM invalid): Fatal, boot aborts.
- TLS mode mismatch (SuperLink TLS, SuperNode insecure or vice versa): Connection failure. Document symptoms: "SSL handshake failed" or "Connection refused" in SuperNode logs.
- SAN mismatch (SuperNode connects to IP not in server cert SAN): Handshake fails. Document symptom: "certificate verify failed" in gRPC logs.
- Missing FL_SSL_CA_CERTFILE in static mode with FL_TLS_ENABLED=YES: Fatal validation error.
- Certificate expired (after 365 days): Runtime failure, redeploy to renew.

**11. Security Considerations**
- The SuperNode never sees the server private key or CA private key. Only the CA certificate (public) is distributed.
- OneGate is the trust distribution channel. It is protected by OneGate tokens. Only VMs in the same OneFlow service can read the FL_CA_CERT attribute.
- For cross-zone deployments (Phase 7 scope), OneGate may not work across zones. Static cert provisioning via FL_SSL_CA_CERTFILE is the fallback.

Include "Relationship to Other Spec Sections" appendix connecting this to 01-superlink-appliance.md, 02-supernode-appliance.md, 04-tls-certificate-lifecycle.md, and future phases.
  </action>
  <verify>
1. File exists at `spec/05-supernode-tls-trust.md`
2. File contains all 11 numbered sections
3. OneGate retrieval includes jq extraction path for FL_TLS and FL_CA_CERT
4. Static provisioning path specifies FL_SSL_CA_CERTFILE requirement
5. TLS mode detection flowchart covers all four cases (explicit YES, explicit NO, OneGate auto, insecure default)
6. Boot sequence modification references Phase 1 steps by number (7, 7b, 10)
7. Docker run command shows --root-certificates ca.crt and single-file mount
8. End-to-end handshake walkthrough covers all 9 steps from SuperLink boot to encrypted gRPC channel
9. ASCII sequence diagram present showing temporal flow
10. Failure modes table covers TLS mismatch, SAN mismatch, missing cert, invalid cert, and expiry scenarios
  </verify>
  <done>
The spec section fully defines the SuperNode-side TLS trust chain: a reader can trace the complete path from SuperNode boot through CA certificate acquisition (OneGate or static), TLS mode detection, Docker container configuration, and gRPC TLS handshake. The end-to-end walkthrough satisfies Phase 2 success criterion #3 -- a reader can follow the complete TLS handshake path from SuperNode boot through certificate retrieval to authenticated gRPC connection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update spec overview with Phase 2 section references</name>
  <files>spec/00-overview.md</files>
  <action>
Update `spec/00-overview.md` to add the two new Phase 2 spec sections to the document navigation and section listing.

Specifically:
1. Add `spec/04-tls-certificate-lifecycle.md` and `spec/05-supernode-tls-trust.md` to the section listing table (following the pattern of existing entries for 01, 02, 03).
2. Update the "Specification Sections" or equivalent navigation section to include the Phase 2 entries with brief descriptions.
3. If there is an architecture diagram, add a note about TLS being the default recommended mode (replacing the Phase 1 insecure annotation).
4. Do NOT rewrite existing content. Only add the Phase 2 references and update the section count.

Keep changes minimal -- this is a navigation update, not a content rewrite.
  </action>
  <verify>
1. `spec/00-overview.md` contains references to both `04-tls-certificate-lifecycle.md` and `05-supernode-tls-trust.md`
2. New entries follow the same format as existing Phase 1 entries
3. Existing content is preserved (diff shows only additions, no deletions of existing content)
  </verify>
  <done>
The spec overview document includes navigation entries for both Phase 2 spec sections, allowing readers to find the TLS specification from the main overview page.
  </done>
</task>

</tasks>

<verification>
Phase-level verification for Plan 02-02:
- Read `spec/05-supernode-tls-trust.md` and confirm it satisfies Phase 2 success criteria #2 (SuperLink publishes CA cert to OneGate, SuperNodes retrieve and trust it) and #3 (complete TLS handshake path traceable)
- Verify the end-to-end walkthrough in section 8 covers: cert generation -> OneGate publication -> cert retrieval -> TLS handshake -> encrypted gRPC
- Verify `spec/00-overview.md` includes both new Phase 2 sections
- Cross-check that the OneGate attributes referenced in this spec (FL_TLS, FL_CA_CERT) match those defined in `spec/04-tls-certificate-lifecycle.md`
</verification>

<success_criteria>
- `spec/05-supernode-tls-trust.md` exists with 11 sections covering trust model, OneGate retrieval, static provisioning, TLS detection, validation, boot changes, Docker run, end-to-end walkthrough, variables, failures, and security
- End-to-end TLS handshake walkthrough covers all 9 steps from SuperLink boot through encrypted gRPC channel
- ASCII sequence diagram shows temporal flow of certificate generation, distribution, and use
- TLS mode detection covers all four cases with clear priority ordering
- Both OneGate and static CA cert acquisition paths are fully specified
- `spec/00-overview.md` updated with Phase 2 section references
- Combined with Plan 02-01, all three Phase 2 success criteria from the roadmap are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-and-certificate-automation/02-02-SUMMARY.md`
</output>
