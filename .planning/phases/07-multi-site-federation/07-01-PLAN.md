---
phase: 07-multi-site-federation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spec/12-multi-site-federation.md
autonomous: true

must_haves:
  truths:
    - "A reader can identify the 3-zone reference topology: SuperLink in Zone A, SuperNodes in Zones B/C, with per-zone OneFlow services"
    - "A reader can choose between WireGuard VPN and direct public IP for cross-zone networking, understanding trade-offs of each"
    - "A reader knows the recommended gRPC keepalive values (60s time, 20s timeout) and why they are needed for WAN paths"
    - "A reader understands that OneGate is zone-local and FL_SUPERLINK_ADDRESS + FL_SSL_CA_CERTFILE become mandatory cross-zone"
    - "A reader can plan a 3-zone federation deployment using only this spec section (end-to-end walkthrough)"
  artifacts:
    - path: "spec/12-multi-site-federation.md"
      provides: "Complete multi-site federation specification"
      min_lines: 400
      contains: "ORCH-02"
  key_links:
    - from: "spec/12-multi-site-federation.md"
      to: "spec/04-tls-certificate-lifecycle.md"
      via: "CA cert distribution model extends Phase 2 static provisioning path"
      pattern: "FL_SSL_CA_CERTFILE"
    - from: "spec/12-multi-site-federation.md"
      to: "spec/08-single-site-orchestration.md"
      via: "Per-zone templates derived from single-site template"
      pattern: "OneFlow"
    - from: "spec/12-multi-site-federation.md"
      to: "spec/03-contextualization-reference.md"
      via: "New CONTEXT variables for keepalive and extra SAN"
      pattern: "FL_GRPC_KEEPALIVE"
---

<objective>
Create the complete multi-site federation specification (spec/12-multi-site-federation.md) covering the 3-zone reference deployment topology, per-zone OneFlow service templates, two cross-zone networking options (WireGuard VPN and direct public IP), gRPC keepalive configuration for WAN resilience, TLS certificate trust distribution across zones, and a step-by-step 3-zone deployment walkthrough.

Purpose: This spec enables Flower federated learning across multiple OpenNebula zones -- the key differentiator for production deployments where training data is distributed across geographically separate data centers.

Output: spec/12-multi-site-federation.md -- a self-contained spec section satisfying requirement ORCH-02 and all 5 phase success criteria.
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-multi-site-federation/07-RESEARCH.md
@spec/04-tls-certificate-lifecycle.md
@spec/05-supernode-tls-trust.md
@spec/08-single-site-orchestration.md
@spec/03-contextualization-reference.md
@spec/00-overview.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create spec/12-multi-site-federation.md -- Topology, Networking, and Per-Zone Templates (Sections 1-6)</name>
  <files>spec/12-multi-site-federation.md</files>
  <action>
Create spec/12-multi-site-federation.md with the standard spec header (Requirement: ORCH-02, Phase: 07, Status: Specification).

Write sections 1-6:

**Section 1: Purpose and Scope.** Define what this section covers (multi-site federation across OpenNebula zones) and what it does not (single-site orchestration is Phase 4, edge/auto-scaling is Phase 9). State the critical architectural constraint upfront: OneGate and OneFlow are zone-local services. Cross-reference spec/08-single-site-orchestration.md for single-site, spec/04-tls-certificate-lifecycle.md and spec/05-supernode-tls-trust.md for TLS.

**Section 2: 3-Zone Reference Deployment Topology.** This is the canonical architecture diagram and narrative:
- Zone A (Coordinator): SuperLink VM, OneFlow Service A (SuperLink role only, singleton), OneGate (local).
- Zone B (Training Site 1): SuperNode VMs (2+), OneFlow Service B (SuperNode role only, no parents dependency), OneGate (local).
- Zone C (Training Site 2): Same as Zone B pattern.
- Include an ASCII diagram showing the three zones, gRPC connections (outbound from SuperNodes to SuperLink), cross-zone connectivity layer (WireGuard or direct IP), and TLS trust distribution via FL_SSL_CA_CERTFILE.
- Explicitly list the 5 key architectural constraints from the research: (1) OneFlow zone-local, (2) OneGate zone-local, (3) FL_SUPERLINK_ADDRESS mandatory for remote SuperNodes, (4) FL_SSL_CA_CERTFILE mandatory for TLS cross-zone, (5) no parents dependency in remote zone templates.

**Section 3: Per-Zone OneFlow Service Templates.** Define two template variants:
- Coordinator Zone Template (Zone A): SuperLink role only, singleton (min_vms=1, max_vms=1). Includes all SuperLink user_inputs from Phase 4 plus FL_TLS_ENABLED=YES as recommended default. No SuperNode role. ready_status_gate: true still applies (SuperLink readiness reporting for OneGate publication).
- Training Site Template (Zone B/C): SuperNode role only, no parents array (SuperLink is external). FL_SUPERLINK_ADDRESS changes from O|text (optional) to M|text (mandatory). FL_SSL_CA_CERTFILE changes from O|text64 to M|text64 when FL_TLS_ENABLED=YES. ready_status_gate: true still applies (per-VM readiness).
- Include complete JSON for both templates (like Phase 4 Section 3 did for the single-site template).
- Document the differences from the single-site template in a comparison table.

**Section 4: Cross-Zone Networking -- WireGuard Site-to-Site VPN.** Cover:
- When to use: SuperLink and SuperNodes on private networks in different data centers.
- Architecture: WireGuard tunnel between zone gateway nodes (two options: dedicated gateway VM or SuperLink-as-gateway, with trade-offs table).
- Configuration template: Zone A wg0.conf and Zone B wg0.conf with variable placeholders. Reference the research's WireGuard config.
- MTU: 1420 (1500 - 60 byte WireGuard overhead).
- Firewall: UDP 51820 between gateway public IPs. Flower TCP 9092 flows inside tunnel.
- Persistence: systemctl enable wg-quick@wg0.
- IP forwarding: sysctl net.ipv4.ip_forward=1.
- Routing: How VMs in each zone reach the WireGuard subnet (static routes or zone router).
- Include a network diagram showing the WireGuard overlay with private subnets.

**Section 5: Cross-Zone Networking -- Direct Public IP.** Cover:
- When to use: SuperLink has a public/routable IP or 1:1 NAT, simpler topology.
- Configuration: SuperLink gets public IP or NAT port forwarding (TCP 9092). SuperNodes set FL_SUPERLINK_ADDRESS to public-ip:9092.
- TLS MANDATORY: traffic traverses public internet. Mark this prominently.
- TLS SAN consideration: auto-generated cert SAN contains private IP, which mismatches public IP. Three resolution options: (1) operator-provided certs with public IP SAN, (2) DNS name with SAN, (3) 1:1 NAT where VM sees public IP.
- New CONTEXT variable: FL_CERT_EXTRA_SAN (O|text) -- comma-separated additional IP or DNS entries to add to auto-generated certificate SAN. Applies to SuperLink only. Example: FL_CERT_EXTRA_SAN=IP:203.0.113.50,DNS:flower.example.com. If unset, auto-generation uses only the primary VM IP (Phase 2 behavior unchanged).
- Trade-offs vs WireGuard: comparison table.

**Section 6: Selection Criteria -- WireGuard vs Direct Public IP.** Decision matrix with criteria: security requirements, network complexity, firewall rules needed, TLS SAN handling, additional infrastructure, performance overhead, recommended for.
  </action>
  <verify>
Check that the file exists and has at least 250 lines covering sections 1-6:
- grep "3-Zone Reference" spec/12-multi-site-federation.md
- grep "WireGuard" spec/12-multi-site-federation.md
- grep "Direct Public IP" spec/12-multi-site-federation.md
- grep "FL_SUPERLINK_ADDRESS" spec/12-multi-site-federation.md
- grep "FL_CERT_EXTRA_SAN" spec/12-multi-site-federation.md
  </verify>
  <done>Sections 1-6 of spec/12-multi-site-federation.md exist with topology diagram, per-zone templates (JSON), WireGuard config, direct public IP option, and selection criteria matrix.</done>
</task>

<task type="auto">
  <name>Task 2: Complete spec/12-multi-site-federation.md -- Connection Resilience, TLS Trust, Walkthrough, Anti-Patterns (Sections 7-12)</name>
  <files>spec/12-multi-site-federation.md</files>
  <action>
Append sections 7-12 to the existing spec/12-multi-site-federation.md:

**Section 7: gRPC Keepalive Configuration.** Cover:
- Why needed: stateful firewalls and NAT devices drop idle TCP connections. Default gRPC keepalive (2 hours) is too long. Flower's 210s default (PR #1069) is better but insufficient for aggressive firewalls (60-600s idle timeout range).
- Recommended values: keepalive_time=60s, keepalive_timeout=20s, permit_without_calls=true.
- Client-side options table (SuperNode): grpc.keepalive_time_ms=60000, grpc.keepalive_timeout_ms=20000, grpc.keepalive_permit_without_calls=1, grpc.http2.max_pings_without_data=0.
- Server-side options table (SuperLink): grpc.keepalive_time_ms=60000, grpc.keepalive_timeout_ms=20000, grpc.keepalive_permit_without_calls=1, grpc.http2.min_recv_ping_interval_without_data_ms=30000, grpc.http2.max_ping_strikes=0.
- CRITICAL coordination rule: client keepalive_time >= server min_recv_ping_interval (else GOAWAY "ENHANCE_YOUR_CALM").
- New CONTEXT variables: FL_GRPC_KEEPALIVE_TIME (O|number, default 60, both appliances), FL_GRPC_KEEPALIVE_TIMEOUT (O|number, default 20, both appliances). Values in seconds; implementation multiplies by 1000 for gRPC millisecond options.
- Translation pseudocode: how configure.sh converts FL_GRPC_KEEPALIVE_TIME to FLOWER_GRPC_KEEPALIVE_TIME_MS env var (or alternative configuration surface).
- Note on Flower integration: Flower internally manages gRPC channel creation with a 210s default. The implementation may need to pass channel options via environment variables or extend Flower's configuration surface. The spec defines the operator interface (CONTEXT vars) and the target gRPC values.

**Section 8: TLS Certificate Trust Across Zones.** Cover:
- The problem: OneGate is zone-local. The auto-discovery TLS path (SuperNode retrieves FL_CA_CERT from OneGate) does not work cross-zone. The static FL_SSL_CA_CERTFILE path from Phase 2 is the cross-zone mechanism.
- Operator workflow for self-signed CA: (1) Deploy Zone A SuperLink with FL_TLS_ENABLED=YES, (2) wait for READY, (3) extract CA cert: ssh + base64 -w0 /opt/flower/certs/ca.crt, (4) paste base64 string into Zone B/C SuperNode template FL_SSL_CA_CERTFILE, (5) deploy Zone B/C.
- Operator workflow for PKI: (1) Generate certs from enterprise CA with correct SANs, (2) set FL_SSL_CA_CERTFILE + FL_SSL_CERTFILE + FL_SSL_KEYFILE on SuperLink, (3) set FL_SSL_CA_CERTFILE on SuperNodes, (4) deploy all zones.
- FL_CERT_EXTRA_SAN integration: when using self-signed CA with WireGuard, set FL_CERT_EXTRA_SAN to include the WireGuard tunnel IP so the SAN matches what SuperNodes connect to. Example: FL_CERT_EXTRA_SAN=IP:10.10.9.0 when SuperLink's WireGuard interface is 10.10.9.0.
- Decision table: when to use self-signed CA vs operator-provided PKI for multi-site.

**Section 9: 3-Zone Deployment Walkthrough.** This is the end-to-end procedure proving SC5. Structure as numbered steps:
- Prerequisites: 3 OpenNebula zones federated, WireGuard or direct IP connectivity established, SuperLink/SuperNode VM templates registered per zone.
- Phase 1: Deploy coordinator zone (Zone A) -- instantiate coordinator OneFlow service, wait for RUNNING, extract SuperLink IP and CA cert.
- Phase 2: Configure training sites (Zones B, C) -- set FL_SUPERLINK_ADDRESS to SuperLink WireGuard IP (or public IP), set FL_SSL_CA_CERTFILE to extracted base64 CA cert, set FL_TLS_ENABLED=YES, set FL_GRPC_KEEPALIVE_TIME=60.
- Phase 3: Deploy training sites -- instantiate training site OneFlow services in Zones B and C (can be parallel).
- Phase 4: Verify federation -- expected behavior: SuperNodes connect to SuperLink, FL_MIN_AVAILABLE_CLIENTS satisfied, training can begin.
- Include a deployment timeline diagram similar to Phase 4's Section 6.
- Include verification commands: oneflow show, ssh to SuperLink to check connected clients, curl OneGate for status.

**Section 10: Failure Modes and Recovery.** Table format like Phase 2 Section 9:
- WireGuard tunnel down: SuperNode gRPC connections fail, Flower --max-retries 0 retries indefinitely, reconnects when tunnel restores.
- SuperLink VM crash in coordinator zone: Same as single-site (Phase 4 Section 9) -- systemd restart, SuperNodes reconnect.
- CA cert mismatch: SuperNode TLS handshake fails ("certificate verify failed"), must verify FL_SSL_CA_CERTFILE matches Zone A CA.
- SAN mismatch: SuperNode TLS fails ("hostname mismatch"), must use FL_CERT_EXTRA_SAN or operator-provided certs.
- Firewall idle timeout: gRPC connection silently dropped, mitigated by keepalive configuration.
- Zone B/C deployed before Zone A: SuperNodes retry indefinitely (--max-retries 0), connects when SuperLink becomes available.

**Section 11: Anti-Patterns.** Table format (consistent with Phase 4 Section 10):
- Trying OneFlow across zones
- Relying on OneGate for cross-zone discovery
- Skipping TLS for cross-zone traffic
- Using auto-generated certs with NAT/public IP without FL_CERT_EXTRA_SAN
- Setting client keepalive_time below server min_recv_ping_interval
- Deploying SuperNodes in coordinator zone template (use single-site template instead)

**Section 12: New Contextualization Variables Summary.** Table listing all new Phase 7 variables:
- FL_GRPC_KEEPALIVE_TIME (both appliances, O|number, default 60)
- FL_GRPC_KEEPALIVE_TIMEOUT (both appliances, O|number, default 20)
- FL_CERT_EXTRA_SAN (SuperLink only, O|text, default empty)
Include USER_INPUT definitions in copy-paste ready format.

End the file with the standard footer: "Specification for ORCH-02: Multi-Site Federation Architecture / Phase: 07 - Multi-Site Federation / Version: 1.0"
  </action>
  <verify>
Check that the complete file covers all success criteria:
- grep "gRPC Keepalive" spec/12-multi-site-federation.md (SC3)
- grep "TLS Certificate Trust" spec/12-multi-site-federation.md (SC4)
- grep "Deployment Walkthrough" spec/12-multi-site-federation.md (SC5)
- grep "Anti-Patterns" spec/12-multi-site-federation.md
- grep "FL_GRPC_KEEPALIVE_TIME" spec/12-multi-site-federation.md
- grep "FL_CERT_EXTRA_SAN" spec/12-multi-site-federation.md
- wc -l spec/12-multi-site-federation.md (expect 400+ lines)
  </verify>
  <done>spec/12-multi-site-federation.md is complete with all 12 sections covering topology, networking options, gRPC keepalive, TLS trust, deployment walkthrough, failure modes, and anti-patterns. All 5 success criteria are addressable from this document alone.</done>
</task>

</tasks>

<verification>
After both tasks complete, verify:
1. spec/12-multi-site-federation.md exists with 400+ lines
2. All 5 success criteria are covered:
   - SC1 (topology): grep "3-Zone Reference" and "Zone A.*Zone B.*Zone C"
   - SC2 (networking options): grep "WireGuard" and "Direct Public IP" and "Selection Criteria"
   - SC3 (gRPC keepalive): grep "keepalive_time_ms" and "60000"
   - SC4 (TLS trust): grep "FL_SSL_CA_CERTFILE" and "cross-zone"
   - SC5 (3-zone walkthrough): grep "Deployment Walkthrough" with step-by-step procedure
3. New CONTEXT variables defined: FL_GRPC_KEEPALIVE_TIME, FL_GRPC_KEEPALIVE_TIMEOUT, FL_CERT_EXTRA_SAN
4. Per-zone OneFlow template JSON included for both coordinator and training site
5. Requirement tag ORCH-02 present in the header
</verification>

<success_criteria>
- spec/12-multi-site-federation.md is a complete, self-contained spec section
- A reader can plan a 3-zone federation deployment using only this document
- Two networking options (WireGuard VPN and direct public IP) are defined with trade-offs
- gRPC keepalive configuration has specific recommended values (60s/20s)
- TLS trust distribution workflow is documented for both self-signed and PKI paths
- All new CONTEXT variables (FL_GRPC_KEEPALIVE_TIME, FL_GRPC_KEEPALIVE_TIMEOUT, FL_CERT_EXTRA_SAN) are defined
</success_criteria>

<output>
After completion, create `.planning/phases/07-multi-site-federation/07-01-SUMMARY.md`
</output>
