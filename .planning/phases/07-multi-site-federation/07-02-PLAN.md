---
phase: 07-multi-site-federation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - spec/03-contextualization-reference.md
  - spec/08-single-site-orchestration.md
  - spec/00-overview.md
autonomous: true

must_haves:
  truths:
    - "FL_GRPC_KEEPALIVE_TIME, FL_GRPC_KEEPALIVE_TIMEOUT, and FL_CERT_EXTRA_SAN appear in the contextualization reference with complete definitions"
    - "The single-site orchestration spec references multi-site federation and directs readers to spec/12"
    - "The overview document lists Phase 7 multi-site federation in its scope"
  artifacts:
    - path: "spec/03-contextualization-reference.md"
      provides: "Updated contextualization reference with Phase 7 variables"
      contains: "FL_GRPC_KEEPALIVE_TIME"
    - path: "spec/08-single-site-orchestration.md"
      provides: "Cross-reference to multi-site federation spec"
      contains: "spec/12-multi-site-federation.md"
    - path: "spec/00-overview.md"
      provides: "Updated overview with Phase 7 scope"
      contains: "Multi-site federation"
  key_links:
    - from: "spec/03-contextualization-reference.md"
      to: "spec/12-multi-site-federation.md"
      via: "Phase 7 variable definitions reference the multi-site spec"
      pattern: "spec/12-multi-site-federation"
    - from: "spec/08-single-site-orchestration.md"
      to: "spec/12-multi-site-federation.md"
      via: "Anti-patterns section references multi-site for cross-zone deployment"
      pattern: "Phase 7"
---

<objective>
Integrate Phase 7 multi-site federation into existing spec documents: add new contextualization variables (FL_GRPC_KEEPALIVE_TIME, FL_GRPC_KEEPALIVE_TIMEOUT, FL_CERT_EXTRA_SAN) to the variable reference, add cross-references from the single-site orchestration spec, and update the overview document to include Phase 7 scope.

Purpose: Ensures the new Phase 7 variables are discoverable in the central reference and that readers navigating from existing specs can find the multi-site content.

Output: Updated spec/03-contextualization-reference.md, spec/08-single-site-orchestration.md, and spec/00-overview.md with Phase 7 integration.
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-multi-site-federation/07-01-SUMMARY.md
@spec/03-contextualization-reference.md
@spec/08-single-site-orchestration.md
@spec/00-overview.md
@spec/12-multi-site-federation.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 7 variables to contextualization reference</name>
  <files>spec/03-contextualization-reference.md</files>
  <action>
Update spec/03-contextualization-reference.md to integrate Phase 7 multi-site federation variables. Follow the same pattern used for Phase 5 and Phase 6 variable additions.

**1. Update the variable count summary table (Section 1):**
- Add a row: "Phase 7 gRPC keepalive/cert | 3 | Both/SuperLink"
- Update total count from 39 to 42 (adding FL_GRPC_KEEPALIVE_TIME, FL_GRPC_KEEPALIVE_TIMEOUT, FL_CERT_EXTRA_SAN)
- Add a note explaining the Phase 7 count similar to the Phase 5 and Phase 6 notes

**2. Update the scope statement (Section 1):**
- Change "plus placeholder variables for Phase 2 (TLS), Phase 3 (ML frameworks), and Phase 6 (GPU)" to include Phase 7 gRPC keepalive and certificate SAN.

**3. Add Phase 7 variables to SuperLink Parameters (Section 3):**
- Add row #20: FL_CERT_EXTRA_SAN | O|text|Additional SAN entries for auto-generated TLS cert (comma-separated IP:/DNS:)||  | text | (empty) | If set: comma-separated entries in format IP:addr or DNS:name. Only effective when FL_TLS_ENABLED=YES and auto-generating certs. | Added to SAN in cert generation (Section 3, spec/04).
- Update the SuperLink parameter count from 19 to 20 and section header text.
- Add FL_CERT_EXTRA_SAN to the SuperLink USER_INPUT Block (copy-paste ready section) under a "# Phase 7: Multi-site federation" comment.

**4. Add Phase 7 shared variables -- create a new subsection in the Shared Infrastructure section OR add to both SuperLink and SuperNode parameter tables:**
- FL_GRPC_KEEPALIVE_TIME: O|number|gRPC keepalive interval in seconds||60 -- Both appliances. Positive integer (>0). Default 60. Maps to grpc.keepalive_time_ms (value * 1000).
- FL_GRPC_KEEPALIVE_TIMEOUT: O|number|gRPC keepalive ACK timeout in seconds||20 -- Both appliances. Positive integer (>0). Default 20. Maps to grpc.keepalive_timeout_ms (value * 1000).

Since these apply to BOTH appliances (like FLOWER_VERSION and FL_LOG_LEVEL), add them to both the SuperLink table (as #21 and #22) and SuperNode table (as #11 and #12). Update counts accordingly: SuperLink goes to 22, SuperNode goes to 12.

Actually, follow the existing pattern more carefully: FLOWER_VERSION appears in both tables separately. Do the same for FL_GRPC_KEEPALIVE_TIME and FL_GRPC_KEEPALIVE_TIMEOUT. Add to SuperLink Parameters as #21-22 and to SuperNode Parameters as #11-12.

Update SuperLink section header: "These 22 variables configure..." (was 19, but actually was already updated to include Phase 5, so count from current state).
Update SuperNode section header: "These 12 variables configure..." (was 10).

Add both to SuperLink and SuperNode USER_INPUT Blocks under "# Phase 7: gRPC keepalive" comment.

**5. Add validation rules (Section 8):**
- FL_GRPC_KEEPALIVE_TIME: Positive integer (>0). Error: "Invalid FL_GRPC_KEEPALIVE_TIME: '${VALUE}'. Must be a positive integer."
- FL_GRPC_KEEPALIVE_TIMEOUT: Positive integer (>0). Error: "Invalid FL_GRPC_KEEPALIVE_TIMEOUT: '${VALUE}'. Must be a positive integer."
- FL_CERT_EXTRA_SAN: If set, must be comma-separated entries matching pattern (IP:[0-9.]+ or DNS:[a-zA-Z0-9.-]+). Error: "Invalid FL_CERT_EXTRA_SAN: '${VALUE}'. Expected comma-separated IP:addr or DNS:name entries."

Add validation pseudocode for the new variables in the validate_config() function.

**6. Add parameter interaction note (Section 10):**
- Add Section 10j: FL_GRPC_KEEPALIVE_TIME and FL_GRPC_KEEPALIVE_TIMEOUT Interaction. Document: both must be set consistently on SuperLink and SuperNode. Client keepalive_time must be >= server min_recv_ping_interval (derived from keepalive_time). Cross-reference spec/12-multi-site-federation.md Section 7.
- Add Section 10k: FL_CERT_EXTRA_SAN and TLS Certificate Generation. Document: only effective when FL_TLS_ENABLED=YES and NOT using operator-provided certs. Adds entries to the SAN in auto-generated certs. Required when SuperLink is accessed via an IP different from its primary NIC (WireGuard tunnel IP, public IP, DNS name). Cross-reference spec/12-multi-site-federation.md Sections 5 and 8.

**7. Update the Appendix cross-reference matrix:**
- Add FL_GRPC_KEEPALIVE_TIME: Y (SuperLink), Y (SuperNode), --, Phase 7
- Add FL_GRPC_KEEPALIVE_TIMEOUT: Y (SuperLink), Y (SuperNode), --, Phase 7
- Add FL_CERT_EXTRA_SAN: Y (SuperLink), --, --, Phase 7

**8. Update the version footer:**
- Change "Version: 1.2" to "Version: 1.3"
- Change "Phase: 01 - Base Appliance Architecture (updated Phase 6)" to "(updated Phase 7)"
  </action>
  <verify>
- grep "FL_GRPC_KEEPALIVE_TIME" spec/03-contextualization-reference.md
- grep "FL_GRPC_KEEPALIVE_TIMEOUT" spec/03-contextualization-reference.md
- grep "FL_CERT_EXTRA_SAN" spec/03-contextualization-reference.md
- grep "Version: 1.3" spec/03-contextualization-reference.md
- grep "Phase 7" spec/03-contextualization-reference.md
  </verify>
  <done>spec/03-contextualization-reference.md includes all 3 new Phase 7 variables with complete definitions, validation rules, interaction notes, and cross-reference matrix entries. Variable count is updated. Version bumped to 1.3.</done>
</task>

<task type="auto">
  <name>Task 2: Add multi-site cross-references to orchestration spec and overview</name>
  <files>spec/08-single-site-orchestration.md, spec/00-overview.md</files>
  <action>
**Update spec/08-single-site-orchestration.md:**

1. In Section 1 (Purpose and Scope), the "What this section does NOT cover" list already includes "Multi-site federation across OpenNebula zones (Phase 7)." Update this to: "Multi-site federation across OpenNebula zones -- see [`spec/12-multi-site-federation.md`](12-multi-site-federation.md) (Phase 7)."

2. In Section 1 cross-references, add a new entry:
   - Multi-site federation: [`spec/12-multi-site-federation.md`](12-multi-site-federation.md) -- cross-zone deployment topology, per-zone OneFlow templates, networking options, gRPC keepalive, TLS trust distribution.

3. In Section 10 (Anti-Patterns), update the "Setting FL_SUPERLINK_ADDRESS in OneFlow deployment" entry. The current text says "Static addresses are intended for standalone VM deployments or cross-site federation (Phase 7), not single-site OneFlow services." Update to: "Static addresses are intended for standalone VM deployments or cross-zone federation (see [`spec/12-multi-site-federation.md`](12-multi-site-federation.md)), not single-site OneFlow services."

**Update spec/00-overview.md:**

1. Update the scope section (Section 1) to include Phase 7:
   - Add to "What this specification covers": "Multi-site federation: cross-zone deployment topology, per-zone OneFlow templates, WireGuard/direct IP networking, gRPC keepalive, TLS trust distribution (Phase 7)."
   - Remove "Multi-site federation (Phase 7)" from "What this specification does NOT cover."

2. Update the Phases line in the header to include Phase 7:
   - Change "Phases: 01 - Base Appliance Architecture, 02 - Security and Certificate Automation, 03 - ML Framework Variants, 04 - Single-Site Orchestration, 05 - Training Configuration" to also include "07 - Multi-Site Federation"
   - Add ORCH-02 to the Requirements line.

3. In the architecture diagram section (Section 2), add a note or brief subsection after the existing diagram:
   "**Multi-site deployment (Phase 7):** In a multi-zone federation, the SuperLink resides in a coordinator zone while SuperNodes are distributed across remote training site zones. Each zone has its own OneFlow service and OneGate. Cross-zone connectivity uses WireGuard VPN or direct public IP. See [`spec/12-multi-site-federation.md`](12-multi-site-federation.md) for the complete multi-site architecture."

4. In the spec document table of contents (if one exists in the overview), add:
   - spec/12-multi-site-federation.md -- Multi-site federation architecture (ORCH-02)
  </action>
  <verify>
- grep "spec/12-multi-site-federation" spec/08-single-site-orchestration.md
- grep "Multi-site federation" spec/00-overview.md
- grep "ORCH-02" spec/00-overview.md
- grep "Phase 7" spec/00-overview.md
  </verify>
  <done>spec/08-single-site-orchestration.md has cross-references to spec/12. spec/00-overview.md includes Phase 7 in scope, requirements, architecture notes, and document table of contents.</done>
</task>

</tasks>

<verification>
After both tasks complete, verify:
1. spec/03-contextualization-reference.md has 3 new variables with validation rules and interaction notes
2. spec/08-single-site-orchestration.md references spec/12-multi-site-federation.md
3. spec/00-overview.md includes Phase 7 in scope and lists ORCH-02
4. No existing variable definitions were accidentally modified (spot-check FL_GPU_ENABLED, FL_STRATEGY still present)
5. Version numbers updated appropriately
</verification>

<success_criteria>
- All 3 new Phase 7 variables (FL_GRPC_KEEPALIVE_TIME, FL_GRPC_KEEPALIVE_TIMEOUT, FL_CERT_EXTRA_SAN) are in spec/03 with complete definitions
- Cross-references from spec/08 and spec/00 point to spec/12-multi-site-federation.md
- Overview document scope includes Phase 7
- No regressions in existing spec content
</success_criteria>

<output>
After completion, create `.planning/phases/07-multi-site-federation/07-02-SUMMARY.md`
</output>
