---
phase: 04-single-site-orchestration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - spec/08-single-site-orchestration.md
  - spec/00-overview.md
autonomous: true

must_haves:
  truths:
    - "The spec defines the end-to-end deployment sequence from user clicking Deploy to service reaching RUNNING state"
    - "The spec explains how ready_status_gate: true gates SuperNode deployment on SuperLink application-level readiness (resolving Open Question #1 from overview)"
    - "The spec defines the OneGate coordination protocol in the context of a OneFlow service, tying together SuperLink publication and SuperNode discovery from Phases 1-2"
    - "A reader can understand what happens at each stage when deploying a 1+N Flower cluster"
    - "The spec defines scaling operations (scale up, scale down) and service lifecycle commands (deploy, undeploy, shutdown)"
    - "The spec defines cardinality configuration and how it maps to OneFlow scaling"
  artifacts:
    - path: "spec/08-single-site-orchestration.md"
      provides: "Complete orchestration spec with deployment sequence, coordination protocol, scaling, and lifecycle"
      contains: "Deployment Sequence"
    - path: "spec/00-overview.md"
      provides: "Updated overview with Phase 4 section reference and resolved Open Question #1"
      contains: "Single-Site Orchestration"
  key_links:
    - from: "spec/08-single-site-orchestration.md"
      to: "spec/01-superlink-appliance.md"
      via: "Deployment sequence references SuperLink boot steps 1-12"
      pattern: "spec/01-superlink-appliance"
    - from: "spec/08-single-site-orchestration.md"
      to: "spec/02-supernode-appliance.md"
      via: "Deployment sequence references SuperNode boot steps 1-13 and discovery"
      pattern: "spec/02-supernode-appliance"
    - from: "spec/00-overview.md"
      to: "spec/08-single-site-orchestration.md"
      via: "Phase 4 section reference in spec overview"
      pattern: "08-single-site-orchestration"
---

<objective>
Complete the Phase 4 orchestration spec: add the deployment sequence walkthrough, OneGate coordination protocol, scaling operations, service lifecycle, and anti-patterns. Then update spec/00-overview.md to include Phase 4's section reference and resolve Open Question #1.

Purpose: This completes the "how" of the orchestration spec -- a reader can trace the entire deployment lifecycle from "click Deploy" to "service RUNNING" and understand how to scale and manage the service. The overview update keeps the spec navigation current.

Output: Completed `spec/08-single-site-orchestration.md` (sections 6-10) and updated `spec/00-overview.md`.
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-single-site-orchestration/04-RESEARCH.md
@.planning/phases/04-single-site-orchestration/04-01-SUMMARY.md

# The file we're extending
@spec/08-single-site-orchestration.md

# Cross-references
@spec/00-overview.md (needs Phase 4 section added)
@spec/01-superlink-appliance.md (Section 6: Boot Sequence, Section 9: Health Check, Section 10: OneGate Publication)
@spec/02-supernode-appliance.md (Section 6: Discovery Model, Section 7: Boot Sequence, Section 10: Health Check)
@spec/04-tls-certificate-lifecycle.md (TLS publication contract)
@spec/05-supernode-tls-trust.md (TLS discovery)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deployment sequence, coordination protocol, and scaling (Sections 6-9)</name>
  <files>spec/08-single-site-orchestration.md</files>
  <action>
Append Sections 6-9 to the existing `spec/08-single-site-orchestration.md`:

**Section 6: Deployment Sequence**
- Provide a detailed, numbered step-by-step deployment walkthrough from "User instantiates service template" to "Service reaches RUNNING state"
- Include approximate timestamps for each phase (use the research timing as reference)
- The sequence MUST cover these critical stages:
  1. User instantiates via Sunstone UI or CLI (oneflow-template instantiate). User_inputs are prompted.
  2. OneFlow creates SuperLink VM from template_id. SuperLink VM enters PENDING -> RUNNING.
  3. SuperLink boot sequence executes (reference spec/01 Section 6, steps 1-12).
  4. SuperLink publishes FL_READY=YES, FL_ENDPOINT, FL_TLS, FL_CA_CERT to OneGate.
  5. SuperLink VM's READY_SCRIPT (health-check.sh) returns 0. REPORT_READY sets READY=YES in VM user template.
  6. **CRITICAL: ready_status_gate satisfied.** OneFlow detects READY=YES on SuperLink VM. Marks superlink role as RUNNING.
  7. OneFlow creates SuperNode VMs (all in parallel) from template_id. SuperNode VMs enter PENDING -> RUNNING.
  8. SuperNode boot sequence executes on each VM (reference spec/02 Section 7, steps 1-13).
  9. SuperNode discovery finds SuperLink via OneGate (first attempt succeeds because SuperLink is already ready).
  10. SuperNode containers start, connect to SuperLink, report READY.
  11. All SuperNode VMs report READY. OneFlow marks supernode role as RUNNING.
  12. All roles RUNNING. Service state transitions to RUNNING.
- Include a timing diagram or ASCII timeline showing the parallel/sequential nature
- Emphasize: Step 6 is the key moment -- this is where ready_status_gate prevents premature SuperNode deployment. Reference spec/01 Section 9 (READY_SCRIPT) and research Pattern 1.
- Note: SuperNode discovery in Step 9 succeeds on first attempt (unlike standalone deployment where retry loop may be needed) BECAUSE ready_status_gate ensures SuperLink is ready before SuperNodes are created

**Section 7: OneGate Coordination Protocol (Service Context)**
- Explain how the existing OneGate publication/discovery contracts (defined in Phase 1-2 specs) function within the OneFlow service context
- SuperLink publication (already defined in spec/01 Section 10):
  - FL_READY=YES, FL_ENDPOINT, FL_VERSION, FL_ROLE=superlink
  - Plus TLS attributes from spec/04: FL_TLS, FL_CA_CERT (when TLS enabled)
  - Publication happens BEFORE ready_status_gate is satisfied (publication is part of the health check path)
- SuperNode discovery (already defined in spec/02 Section 6c-6d):
  - OneGate GET /service retrieves the full service definition
  - jq filter extracts FL_ENDPOINT from the superlink role's nodes
  - In OneFlow context: discovery succeeds on first attempt (ready_status_gate ensures SuperLink published before SuperNode boots)
  - Retry loop still present as defense-in-depth for edge cases (OneGate caching delays, race conditions)
- Include the verified OneGate /service response JSON structure from research (Pattern 3)
- Explain the data flow: SuperLink PUT -> OneGate stores in USER_TEMPLATE -> SuperNode GET /service -> parse -> extract FL_ENDPOINT
- Note: TOKEN=YES in both VM templates is REQUIRED for OneGate to work. This is in the infrastructure CONTEXT, not user_inputs.
- Defensive jq filter: recommend filtering by FL_READY=YES (not just nodes[0]) for defense-in-depth:
  ```
  .SERVICE.roles[] | select(.name == "superlink")
  | .nodes[] | select(.vm_info.VM.USER_TEMPLATE.FL_READY == "YES")
  | .vm_info.VM.USER_TEMPLATE.FL_ENDPOINT
  ```

**Section 8: Scaling Operations**
- Scale SuperNode count UP: `oneflow scale <service_id> supernode <N>`
  - New SuperNodes follow the same boot sequence (Steps 8-13 from Section 6)
  - They discover SuperLink via OneGate (already published)
  - Auto-partition-id: new SuperNodes get index based on updated nodes array length
  - Important: newly scaled SuperNodes get new partition-ids that may overlap with or differ from original partitioning. Document this as a known limitation -- for production use, partition-id should be managed externally or via FL_NODE_CONFIG override.
- Scale SuperNode count DOWN: `oneflow scale <service_id> supernode <N>`
  - OneFlow removes VMs (newest first by default)
  - Flower handles client disconnection gracefully (remaining clients continue)
  - Active training round continues if remaining clients >= FL_MIN_FIT_CLIENTS
- SuperLink CANNOT be scaled (min_vms=1, max_vms=1). Document the error behavior.
- Include the CLI commands from research (oneflow scale, oneflow show, etc.)
- Note on elasticity policies: only applicable to supernode role. Defer detailed auto-scaling triggers to Phase 9.

**Section 9: Service Lifecycle Management**
- Service states: PENDING -> DEPLOYING -> RUNNING -> SCALING -> UNDEPLOYING -> DONE
- Deploy: `oneflow-template instantiate <template_id>` (or via Sunstone UI)
- Deploy with overrides: `oneflow-template instantiate <template_id> --extra_template '{"custom_attrs_values": {...}}'`
- Show status: `oneflow show <service_id>`
- Undeploy: `oneflow delete <service_id>` -- reverse order (SuperNodes terminated first, then SuperLink). This is correct behavior because SuperLink should be last to go.
- Shutdown action: "shutdown" (graceful OS shutdown, not hard power-off). Docker receives SIGTERM, Flower shuts down gracefully.
- Failure handling:
  - If SuperLink fails to report READY: service stays in DEPLOYING state. Timeout behavior depends on OneFlow service timeout configuration.
  - If a SuperNode fails to report READY: other SuperNodes may still report ready. Service depends on min_vms threshold.
  - If SuperLink VM crashes after service is RUNNING: systemd restarts container. SuperNodes reconnect via Flower retry. Service may temporarily enter WARNING state.
  </action>
  <verify>
Verify sections 6-9 exist in spec/08-single-site-orchestration.md. Check that Section 6 includes the numbered deployment sequence with ready_status_gate as the critical step. Check that Section 7 references the OneGate publication/discovery contracts from spec/01 and spec/02. Check that Section 8 includes both scale-up and scale-down commands. Check Section 9 includes service lifecycle states and undeploy reverse ordering.
  </verify>
  <done>Sections 6-9 complete the orchestration spec with deployment sequence (12-step walkthrough with ready_status_gate as critical gate), OneGate coordination protocol in service context, scaling operations, and service lifecycle management.</done>
</task>

<task type="auto">
  <name>Task 2: Add anti-patterns section, spec footer, and update overview</name>
  <files>spec/08-single-site-orchestration.md, spec/00-overview.md</files>
  <action>
**Part A: Add Section 10 (Anti-Patterns and Pitfalls) and footer to spec/08-single-site-orchestration.md**

Append Section 10 and spec footer:

**Section 10: Anti-Patterns and Pitfalls**
Create a table of anti-patterns with columns: Anti-Pattern, What Goes Wrong, Correct Approach. Include:
1. Setting ready_status_gate: false -- SuperNodes deploy before SuperLink is ready, waste 5 min in retry loop
2. SuperLink cardinality > 1 -- split-brain federation, SuperNodes discover random SuperLink
3. Duplicating user_inputs at both service and role level -- role overrides service, version mismatch risk
4. Missing TOKEN=YES in VM template CONTEXT -- all OneGate calls fail (401), discovery fails, REPORT_READY fails
5. Putting infrastructure vars in user_inputs instead of template CONTEXT -- users see TOKEN/REPORT_READY in Sunstone UI, confusing
6. Setting FL_SUPERLINK_ADDRESS in OneFlow deployment -- bypasses OneGate discovery, defeats purpose of orchestration
7. Elasticity policies on superlink role -- auto-scaling the singleton coordinator causes split-brain
8. Using deployment: "none" instead of "straight" -- all VMs deploy simultaneously, race condition

Add spec footer:
```
---

*Specification for ORCH-01: Single-Site Orchestration*
*Phase: 04 - Single-Site Orchestration*
*Version: 1.0*
```

**Part B: Update spec/00-overview.md**

1. Update the header to include Phase 4:
   - Change `**Phases:** 01 - Base Appliance Architecture, 02 - Security and Certificate Automation` to include Phase 3 and Phase 4

2. Update Section 1 (Scope) "What this phase covers" to add a bullet for Phase 4:
   - Add "Single-site orchestration: the OneFlow service template that deploys a complete 1+N Flower cluster with automatic dependency ordering."

3. Update Section 4 (Spec Sections) to add Phase 3 and Phase 4 tables:
   - Phase 3 table: ML Framework Variants (spec/06) and Use Case Templates (spec/07)
   - Phase 4 table: Single-Site Orchestration (spec/08)

4. Resolve Open Question #1: Change the status of "Does OneFlow wait for REPORT_READY before marking a role as ready for child roles?" from "Unresolved" to "Resolved" with the answer: "YES. When ready_status_gate: true is set at the service level, OneFlow requires READY=YES in the VM's user template before considering the VM running for role dependency purposes. See spec/08-single-site-orchestration.md Section 6."

5. Update the Version to 1.2 (it's currently 1.1 from Phase 2)
  </action>
  <verify>
Verify spec/08-single-site-orchestration.md has Section 10 and the spec footer. Verify spec/00-overview.md includes a Phase 4 entry in Section 4, Open Question #1 status is "Resolved", and the version is updated.
  </verify>
  <done>Anti-patterns section added to orchestration spec. Overview updated with Phase 4 section reference, Open Question #1 resolved (ready_status_gate confirmed), and version bumped to 1.2.</done>
</task>

</tasks>

<verification>
1. `spec/08-single-site-orchestration.md` is complete with sections 1-10 and spec footer
2. Section 6 contains a numbered deployment sequence showing ready_status_gate as the critical gate
3. Section 7 ties together SuperLink publication (spec/01) and SuperNode discovery (spec/02) in service context
4. Section 8 documents scale-up/down commands and SuperLink scaling prevention
5. Section 9 documents service lifecycle states and reverse-order undeploy
6. Section 10 lists 8 anti-patterns with correct approaches
7. `spec/00-overview.md` includes Phase 4 section reference
8. Open Question #1 in overview is marked Resolved
9. Overview version bumped to 1.2
</verification>

<success_criteria>
A reader can trace the complete deployment lifecycle of a 1+N Flower cluster: from clicking Deploy in Sunstone through service reaching RUNNING state, scaling operations, and undeploy. The spec resolves all orchestration open questions and provides actionable anti-pattern guidance. The overview is updated to navigate to the new spec section.
</success_criteria>

<output>
After completion, create `.planning/phases/04-single-site-orchestration/04-02-SUMMARY.md`
</output>
