---
phase: 04-single-site-orchestration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spec/08-single-site-orchestration.md
autonomous: true

must_haves:
  truths:
    - "The spec includes a complete OneFlow service template JSON with superlink parent role (cardinality 1) and supernode child role (cardinality N)"
    - "The spec defines straight deployment ordering with ready_status_gate: true"
    - "The spec maps service-level user_inputs (shared: FLOWER_VERSION, FL_TLS_ENABLED, FL_LOG_LEVEL) and role-level user_inputs (SuperLink: strategy/rounds, SuperNode: framework/use-case)"
    - "The spec defines SuperLink cardinality hard-constrained to 1 (min_vms:1, max_vms:1) and SuperNode default cardinality 2, min 2, max 10"
    - "The spec defines per-SuperNode FL_NODE_CONFIG differentiation via VM index for partition-id assignment"
  artifacts:
    - path: "spec/08-single-site-orchestration.md"
      provides: "OneFlow service template definition with roles, user_inputs, and cardinality"
      contains: "OneFlow Service Template"
  key_links:
    - from: "spec/08-single-site-orchestration.md"
      to: "spec/01-superlink-appliance.md"
      via: "SuperLink role references SuperLink appliance VM template"
      pattern: "spec/01-superlink-appliance"
    - from: "spec/08-single-site-orchestration.md"
      to: "spec/02-supernode-appliance.md"
      via: "SuperNode role references SuperNode appliance VM template"
      pattern: "spec/02-supernode-appliance"
    - from: "spec/08-single-site-orchestration.md"
      to: "spec/03-contextualization-reference.md"
      via: "User_inputs reference contextualization variable definitions"
      pattern: "spec/03-contextualization-reference"
---

<objective>
Create the first half of the Phase 4 orchestration spec: the OneFlow service template definition with complete JSON, role structure, user_inputs mapping, cardinality configuration, and per-SuperNode differentiation.

Purpose: This spec section defines the "what" -- the exact service template structure that deploys a complete Flower cluster as a single OneFlow service. It is the reference artifact an engineer uses to register the Flower service template in the marketplace.

Output: `spec/08-single-site-orchestration.md` containing sections 1-5 of the orchestration spec.
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-single-site-orchestration/04-RESEARCH.md

# Existing spec files that Phase 4 builds on
@spec/00-overview.md
@spec/01-superlink-appliance.md (Section 10: OneGate Publication Contract, Section 12: Parameters)
@spec/02-supernode-appliance.md (Section 6: Discovery Model, Section 13: Parameters)
@spec/03-contextualization-reference.md (full variable reference)
@spec/06-ml-framework-variants.md (ML_FRAMEWORK variable)
@spec/07-use-case-templates.md (FL_USE_CASE variable)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OneFlow service template specification (Sections 1-3)</name>
  <files>spec/08-single-site-orchestration.md</files>
  <action>
Create `spec/08-single-site-orchestration.md` with the following structure:

**Header:**
- Requirement: ORCH-01
- Phase: 04 - Single-Site Orchestration
- Status: Specification

**Section 1: Purpose and Scope**
- Define scope: OneFlow service template for single-site Flower cluster deployment (1 SuperLink + N SuperNodes)
- State what this covers: service template JSON, deployment ordering, user_inputs mapping, cardinality, per-node differentiation, deployment sequence, scaling, lifecycle
- State what this does NOT cover: multi-site federation (Phase 7), auto-scaling triggers (Phase 9), training configuration (Phase 5)
- Cross-reference: builds on spec/01 (SuperLink), spec/02 (SuperNode), spec/03 (contextualization), spec/04-05 (TLS), spec/06-07 (framework/use-case)

**Section 2: Service Template Architecture**
- Architecture diagram showing OneFlow service template wrapping SuperLink and SuperNode VM templates
- Explain the three-level configuration hierarchy:
  1. Service-level user_inputs (shared across all roles): FLOWER_VERSION, FL_TLS_ENABLED, FL_LOG_LEVEL
  2. SuperLink role-level user_inputs: FL_NUM_ROUNDS, FL_STRATEGY, FL_MIN_FIT_CLIENTS, FL_MIN_EVALUATE_CLIENTS, FL_MIN_AVAILABLE_CLIENTS
  3. SuperNode role-level user_inputs: ML_FRAMEWORK, FL_USE_CASE, FL_NODE_CONFIG
- Explain WHY each variable goes at service vs role level (shared consistency vs role-specific)
- Note that role-level overrides service-level (document this as a pitfall to avoid)
- Infrastructure CONTEXT variables (TOKEN=YES, REPORT_READY=YES, READY_SCRIPT_PATH, NETWORK=YES) are in the VM template CONTEXT, NOT in user_inputs

**Section 3: Complete Service Template JSON**
- Provide the COMPLETE OneFlow service template JSON (use the research example as the base, but ensure it uses OpenNebula 7.0 field names: template_id, user_inputs, template_contents)
- Include ALL fields: name, description, deployment: "straight", ready_status_gate: true, shutdown_action: "shutdown"
- SuperLink role: name "superlink", type "vm", template_id: 0 (placeholder), cardinality: 1, min_vms: 1, max_vms: 1, shutdown_action: "shutdown", user_inputs with SuperLink-specific vars
- SuperNode role: name "supernode", type "vm", template_id: 0 (placeholder), cardinality: 2, min_vms: 2, max_vms: 10, parents: ["superlink"], shutdown_action: "shutdown", user_inputs with SuperNode-specific vars
- Add template_contents for each role with infrastructure CONTEXT vars (TOKEN=YES, REPORT_READY=YES, etc.)
- After the JSON, provide field-by-field annotations explaining each significant field
- Note on template_id: placeholder 0, actual IDs assigned at marketplace registration time
- Note on backward compatibility: mention 6.x field names (vm_template, custom_attrs, vm_template_contents) as aliases

The JSON must be valid and complete -- an engineer should be able to use it as a starting point by replacing template_id values.
  </action>
  <verify>
Verify that `spec/08-single-site-orchestration.md` exists with sections 1-3. Check that the JSON includes: "deployment": "straight", "ready_status_gate": true, both roles defined, superlink has min_vms:1/max_vms:1, supernode has parents:["superlink"], service-level user_inputs include FLOWER_VERSION/FL_TLS_ENABLED/FL_LOG_LEVEL, role-level user_inputs are properly split.
  </verify>
  <done>Sections 1-3 of the orchestration spec exist with a complete, annotated OneFlow service template JSON that matches all research findings and correctly partitions user_inputs between service and role levels.</done>
</task>

<task type="auto">
  <name>Task 2: Add cardinality configuration and per-node differentiation (Sections 4-5)</name>
  <files>spec/08-single-site-orchestration.md</files>
  <action>
Append Sections 4-5 to the existing `spec/08-single-site-orchestration.md`:

**Section 4: Cardinality Configuration**
- SuperLink cardinality: MUST be exactly 1. Hard-constrained via min_vms:1, max_vms:1. Explain WHY (Flower SuperLink is a singleton coordinator; multiple instances cause split-brain federation). Document what happens if someone tries to scale SuperLink (OneFlow enforces max_vms bound). No elasticity_policies on superlink role.
- SuperNode cardinality:
  - Default: 2 (minimum for meaningful federated learning)
  - Minimum: 2 (FL requires at least 2 clients for FedAvg)
  - Maximum: 10 (reasonable default; operator can adjust in template)
  - Explain how min/max interact with FL_MIN_AVAILABLE_CLIENTS (cardinality min should be >= FL_MIN_AVAILABLE_CLIENTS for the service to become fully operational)
- Cardinality override at instantiation: document how the user can override default cardinality when instantiating a service (oneflow-template instantiate with --extra_template)
- Table summarizing cardinality constraints for both roles

**Section 5: Per-SuperNode Differentiation (FL_NODE_CONFIG)**
- Problem statement: OneFlow's user_inputs apply the same value to all VMs in a role. But each SuperNode needs a unique partition-id for data partitioning.
- Solution: The SuperNode boot script computes partition-id from its position in the OneFlow service. The mechanism:
  1. During discovery (Step 7 in SuperNode boot), the SuperNode already queries OneGate GET /service
  2. The response contains the list of nodes in the supernode role
  3. The boot script finds its own VMID in the nodes array and uses its 0-based index as partition-id
  4. num-partitions is the cardinality of the supernode role (from the same response)
  5. These are injected into FL_NODE_CONFIG automatically if FL_NODE_CONFIG is empty/unset
  6. If FL_NODE_CONFIG is already set by the user, the auto-computed values are NOT applied (user override takes precedence)
- Provide pseudocode for the auto-partition-id computation:
  ```
  NODES=$(echo "$SERVICE_JSON" | jq '.SERVICE.roles[] | select(.name == "supernode") | .nodes')
  NUM_PARTITIONS=$(echo "$NODES" | jq 'length')
  MY_INDEX=$(echo "$NODES" | jq --arg vmid "$VMID" '[.[].deploy_id] | to_entries[] | select(.value == $vmid) | .key')
  AUTO_NODE_CONFIG="partition-id=${MY_INDEX} num-partitions=${NUM_PARTITIONS}"
  ```
- Document the edge case: if the SuperNode cannot determine its index (e.g., standalone deployment without OneFlow), the auto-computation is skipped and the user must provide FL_NODE_CONFIG manually
- Note: this mechanism is only relevant when using pre-built use case templates (FL_USE_CASE != none). Custom ClientApps may handle partitioning differently.

Add a footer matching the existing spec format:
```
*Specification for ORCH-01: Single-Site Orchestration*
*Phase: 04 - Single-Site Orchestration*
*Version: 1.0*
```
(But do NOT add the footer yet -- Plan 02 will add more sections and the footer at the end.)
  </action>
  <verify>
Verify that sections 4 and 5 exist in the file. Check that Section 4 includes the cardinality table and SuperLink singleton constraint. Check that Section 5 includes the partition-id computation pseudocode and user-override precedence rule.
  </verify>
  <done>Sections 4-5 added covering cardinality configuration (SuperLink hard-constrained to 1, SuperNode 2-10) and per-SuperNode FL_NODE_CONFIG auto-computation via VM index from OneGate service response.</done>
</task>

</tasks>

<verification>
1. `spec/08-single-site-orchestration.md` exists with sections 1-5
2. Section 3 contains valid JSON with `"deployment": "straight"` and `"ready_status_gate": true`
3. SuperLink role has `min_vms: 1, max_vms: 1` (singleton constraint)
4. SuperNode role has `parents: ["superlink"]` and `min_vms: 2, max_vms: 10`
5. Service-level user_inputs: FLOWER_VERSION, FL_TLS_ENABLED, FL_LOG_LEVEL
6. SuperLink role user_inputs: FL_NUM_ROUNDS, FL_STRATEGY, FL_MIN_FIT_CLIENTS, FL_MIN_EVALUATE_CLIENTS, FL_MIN_AVAILABLE_CLIENTS
7. SuperNode role user_inputs: ML_FRAMEWORK, FL_USE_CASE, FL_NODE_CONFIG
8. Section 5 includes partition-id auto-computation pseudocode
9. Cross-references to spec/01, spec/02, spec/03 are present
</verification>

<success_criteria>
The first half of the orchestration spec defines the complete service template structure that an engineer could use to register a Flower service in the OpenNebula marketplace. All user_inputs are correctly partitioned between service-level and role-level. Cardinality constraints prevent SuperLink scaling. Per-SuperNode differentiation is solved via auto-computed partition-id.
</success_criteria>

<output>
After completion, create `.planning/phases/04-single-site-orchestration/04-01-SUMMARY.md`
</output>
