---
phase: 03-ml-framework-variants-and-use-cases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [spec/06-ml-framework-variants.md]
autonomous: true

must_haves:
  truths:
    - "The spec defines exactly three appliance variants (PyTorch, TensorFlow, scikit-learn) with distinct Docker images extending flwr/supernode"
    - "Each variant has a documented image size target and the packages it installs"
    - "The spec includes a decision record explaining why multiple variants over a single fat image, and why these three frameworks"
    - "The ML_FRAMEWORK contextualization variable selects which variant Docker image the SuperNode runs"
    - "The spec defines how configure.sh uses ML_FRAMEWORK to select the correct Docker image tag at boot"
  artifacts:
    - path: "spec/06-ml-framework-variants.md"
      provides: "Complete appliance variant strategy specification (APPL-05)"
      contains: "APPL-05"
      min_lines: 200
  key_links:
    - from: "spec/06-ml-framework-variants.md"
      to: "spec/02-supernode-appliance.md"
      via: "Extends SuperNode image components with framework-specific Docker images"
      pattern: "flwr/supernode"
    - from: "spec/06-ml-framework-variants.md"
      to: "spec/03-contextualization-reference.md"
      via: "References ML_FRAMEWORK placeholder variable and defines its runtime behavior"
      pattern: "ML_FRAMEWORK"
---

<objective>
Write the ML framework variant strategy specification defining three framework-specific SuperNode appliance images (PyTorch, TensorFlow, scikit-learn), their Dockerfiles, image size targets, and the decision record justifying the variant approach.

Purpose: Satisfies APPL-05 (appliance variants for ML frameworks with image size targets). This spec section enables implementers to build framework-specific QCOW2 images and defines how ML_FRAMEWORK selects the correct Docker image at boot.

Output: `spec/06-ml-framework-variants.md` -- complete variant strategy specification
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ml-framework-variants-and-use-cases/03-RESEARCH.md

@spec/00-overview.md
@spec/01-superlink-appliance.md
@spec/02-supernode-appliance.md
@spec/03-contextualization-reference.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write appliance variant strategy specification</name>
  <files>spec/06-ml-framework-variants.md</files>
  <action>
Create `spec/06-ml-framework-variants.md` as a complete specification section covering APPL-05. The document MUST follow the established spec style from Phase 1 (numbered sections, tables, pseudocode blocks, clear requirement traceability).

**Document structure (follow this outline):**

1. **Purpose and Scope** -- This section defines the appliance variant strategy: three framework-specific Docker images extending `flwr/supernode`, each pre-baked into a framework-specific QCOW2 image. Reference APPL-05 requirement.

2. **Variant Strategy Overview** -- Table of the three variants (PyTorch, TensorFlow, scikit-learn) with:
   - Docker image name (use naming pattern: `flower-supernode-{framework}:{FLOWER_VERSION}`)
   - Base image (`flwr/supernode:1.25.0`)
   - Key packages installed
   - Estimated Docker image size (compressed)
   - Estimated QCOW2 image size
   - Primary use cases

3. **Dockerfile Specifications** -- For each of the three variants, provide a complete Dockerfile. Follow these rules from research:
   - `FROM flwr/supernode:1.25.0`
   - PyTorch: Install `torch` and `torchvision` with CPU-only index URL (`https://download.pytorch.org/whl/cpu`). Include `flwr-datasets[vision]`, `tqdm`. Also include LLM fine-tuning deps (`bitsandbytes`, `peft`, `transformers`) since LLM fine-tuning use case requires PyTorch. Document the size impact (~500 MB additional for LLM deps).
   - TensorFlow: Install `tensorflow-cpu` (NOT `tensorflow` -- avoid CUDA stubs). Include `flwr-datasets[vision]`, `tqdm`.
   - scikit-learn: Install `scikit-learn`, `pandas`, `flwr-datasets`. Lightest variant.
   - All Dockerfiles: Use `--no-cache-dir` for pip installs. Switch to `USER app` for pip installs (match Flower's non-root pattern). Include `USER root` only for apt-get if needed, then switch back.

4. **Image Size Targets** -- Table with soft targets:
   - PyTorch variant: ~800 MB-1.2 GB Docker image, ~4-5 GB QCOW2 (includes LLM deps)
   - TensorFlow variant: ~500-700 MB Docker image, ~3-4 GB QCOW2
   - scikit-learn variant: ~300-400 MB Docker image, ~2.5-3 GB QCOW2
   - Note these are estimates to be validated during implementation.

5. **ML_FRAMEWORK Variable Behavior** -- Define how the existing `ML_FRAMEWORK` contextualization variable (already a Phase 3 placeholder in spec/03-contextualization-reference.md) selects the Docker image at boot. Provide the configure.sh case statement:
   ```bash
   case "${ML_FRAMEWORK:-pytorch}" in
       pytorch)    IMAGE_TAG="flower-supernode-pytorch:${FLOWER_VERSION}" ;;
       tensorflow) IMAGE_TAG="flower-supernode-tensorflow:${FLOWER_VERSION}" ;;
       sklearn)    IMAGE_TAG="flower-supernode-sklearn:${FLOWER_VERSION}" ;;
       *)          log "ERROR" "Unknown ML_FRAMEWORK: '${ML_FRAMEWORK}'"; exit 1 ;;
   esac
   ```
   Document the fallback behavior: if the selected framework image is not pre-baked, Docker attempts to pull it (same pattern as FLOWER_VERSION override from Phase 1 spec).

6. **QCOW2 Build Strategy** -- Define how framework-specific QCOW2 images are built:
   - Three separate QCOW2 images (not one fat image with all frameworks)
   - Each QCOW2 pre-pulls its framework-specific Docker image at build time
   - The base SuperNode QCOW2 (from Phase 1) pre-pulls only `flwr/supernode:1.25.0`; variant QCOWs additionally pre-pull the extended image
   - Marketplace listing: three separate appliance entries (e.g., "Flower SuperNode - PyTorch", "Flower SuperNode - TensorFlow", "Flower SuperNode - scikit-learn")

7. **Decision Record: Variant Strategy** -- Formal ADR-style decision record answering:
   - **Why multiple variants over a single fat image?** (size, framework conflicts, update agility, marketplace clarity, air-gapped deployment efficiency)
   - **Why these three frameworks?** (PyTorch: most popular for FL/research, FlowerTune; TensorFlow: enterprise/Keras; scikit-learn: lightweight/tabular)
   - **Why not others?** (JAX: niche; XGBoost: specific use case; HuggingFace: library not framework, runs on PyTorch)
   - **Why include LLM deps in PyTorch variant?** (avoids a fourth variant; LLM fine-tuning always requires PyTorch; documented size impact)
   - Use the decision record inputs from the research document.

8. **Interaction with Existing Spec Sections** -- Cross-references:
   - `spec/02-supernode-appliance.md` Section 2 (Image Components): variant images extend the base
   - `spec/03-contextualization-reference.md` Section 6 (ML_FRAMEWORK placeholder): now functional in Phase 3
   - Boot sequence impact: Step 6 (Docker image loading) now checks ML_FRAMEWORK to select image tag

**Style requirements:**
- Use the same markdown structure as existing spec files (numbered sections with `###`, tables, code blocks)
- Include "Requirement: APPL-05" and "Phase: 03" header
- End with spec footer matching existing files
  </action>
  <verify>
1. File exists: `ls spec/06-ml-framework-variants.md`
2. Contains all required sections: grep for "Decision Record", "Dockerfile", "ML_FRAMEWORK", "QCOW2 Build Strategy", "Image Size Targets"
3. Contains all three variants: grep for "pytorch", "tensorflow", "sklearn"
4. References APPL-05: grep for "APPL-05"
5. Contains complete Dockerfiles: grep for "FROM flwr/supernode"
6. Document is substantive: `wc -l spec/06-ml-framework-variants.md` should be >200 lines
  </verify>
  <done>
spec/06-ml-framework-variants.md exists with all 8 sections, defines three framework variants with Dockerfiles and size targets, includes the ML_FRAMEWORK selection logic, and contains a formal decision record justifying the variant approach. A reader can identify every variant, its packages, its size target, and the rationale for the split.
  </done>
</task>

</tasks>

<verification>
- spec/06-ml-framework-variants.md exists and covers APPL-05
- Three variants defined with Docker images, Dockerfiles, and size targets
- ML_FRAMEWORK variable behavior fully specified
- Decision record answers "why these frameworks" and "why not a single fat image"
- Cross-references to Phase 1 spec sections are present
- Document follows established spec style (numbered sections, tables, code blocks)
</verification>

<success_criteria>
1. A reader can identify every component of each variant (base image, added packages, Docker image name, QCOW2 size target)
2. A reader can build any of the three Docker images from the provided Dockerfiles
3. The ML_FRAMEWORK variable's runtime behavior is fully specified with configure.sh pseudocode
4. The decision record explains the variant strategy with clear arguments
</success_criteria>

<output>
After completion, create `.planning/phases/03-ml-framework-variants-and-use-cases/03-01-SUMMARY.md`
</output>
