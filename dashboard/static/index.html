<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flower FL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');
    :root {
      --bg: #f4f6f9;
      --surface: #ffffff;
      --border: #dde1e8;
      --text-primary: #1b2332;
      --text-secondary: #576171;
      --text-tertiary: #8e96a4;
      --accent: #2ea3f2;
      --green: #27ae60;
      --orange: #e67e22;
      --red: #e74c3c;
      --nav-bg: rgba(244,246,249,0.85);
      --node-fill: white;
      --shadow-color: rgba(0,0,0,0.06);
      --chart-grid: #e8ecf1;
      --progress-track: #e8ecf1;
      --scrollbar: #c8cdd6;
    }
    [data-theme="dark"] {
      --bg: #111827;
      --surface: #1e2738;
      --border: #2d3a4e;
      --text-primary: #ffffff;
      --text-secondary: #d1d5db;
      --text-tertiary: #9ca3af;
      --accent: #38b6ff;
      --green: #34d399;
      --orange: #fbbf24;
      --red: #f87171;
      --nav-bg: rgba(17,24,39,0.9);
      --node-fill: #1e2738;
      --shadow-color: rgba(0,0,0,0.5);
      --chart-grid: #283346;
      --progress-track: #283346;
      --scrollbar: #3b4a60;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', 'Helvetica Neue', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }
    .mono { font-family: 'JetBrains Mono', 'SF Mono', 'Menlo', monospace; }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      transition: box-shadow 0.3s ease;
    }
    .card:hover { box-shadow: 0 4px 24px var(--shadow-color); }

    /* Topology canvas */
    #topology-canvas {
      width: 100%;
      height: 320px;
    }

    /* Animated gradient lines for data flow */
    @keyframes flowIn {
      0% { stroke-dashoffset: 20; }
      100% { stroke-dashoffset: 0; }
    }
    @keyframes flowOut {
      0% { stroke-dashoffset: 0; }
      100% { stroke-dashoffset: -20; }
    }
    .flow-in { animation: flowIn 1.5s linear infinite; }
    .flow-out { animation: flowOut 1.5s linear infinite; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .pulse { animation: pulse 2s ease-in-out infinite; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-up { animation: fadeUp 0.4s ease-out forwards; }

    /* Progress ring */
    .progress-ring { transform: rotate(-90deg); }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 3px; }

    /* Theme toggle */
    .theme-toggle {
      width: 36px; height: 20px; border-radius: 10px;
      background: var(--border); position: relative; cursor: pointer;
      transition: background 0.3s ease; border: none; padding: 0;
    }
    .theme-toggle::after {
      content: ''; position: absolute; top: 2px; left: 2px;
      width: 16px; height: 16px; border-radius: 50%;
      background: var(--surface); transition: transform 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    [data-theme="dark"] .theme-toggle { background: var(--accent); }
    [data-theme="dark"] .theme-toggle::after { transform: translateX(16px); }

    /* Control panel form elements */
    .cp-select, .cp-input {
      width: 100%;
      padding: 6px 10px;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s;
    }
    .cp-select:focus, .cp-input:focus {
      border-color: var(--accent);
    }
    .cp-label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    /* Info tooltip */
    .info-tip {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 13px;
      height: 13px;
      border-radius: 50%;
      border: 1px solid var(--text-tertiary);
      color: var(--text-tertiary);
      font-size: 9px;
      font-weight: 600;
      font-style: italic;
      font-family: Georgia, serif;
      cursor: help;
      flex-shrink: 0;
      transition: border-color 0.2s, color 0.2s;
    }
    .info-tip:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .info-tip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: var(--bg);
      font-size: 11px;
      font-weight: 400;
      font-style: normal;
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
      text-transform: none;
      letter-spacing: normal;
      line-height: 1.4;
      padding: 6px 10px;
      border-radius: 8px;
      white-space: normal;
      width: max-content;
      max-width: 200px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 10;
    }
    .info-tip:hover::after {
      opacity: 1;
    }

    /* Training log terminal */
    .log-terminal {
      background: #0d1117;
      color: #c9d1d9;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.5;
      padding: 12px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    [data-theme="dark"] .log-terminal {
      background: #0a0e14;
    }
    .log-line-error { color: #f87171; }
    .log-line-success { color: #34d399; }

    /* Upload drop zone */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 24px 16px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--accent);
      background: rgba(46, 163, 242, 0.04);
    }
    [data-theme="dark"] .drop-zone:hover,
    [data-theme="dark"] .drop-zone.dragover {
      background: rgba(56, 182, 255, 0.06);
    }

    /* Toast notifications */
    #toast-container {
      position: fixed;
      top: 60px;
      right: 16px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    .toast {
      pointer-events: auto;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      animation: toastIn 0.3s ease-out forwards;
      max-width: 360px;
    }
    .toast-success {
      background: var(--green);
      color: #fff;
    }
    .toast-error {
      background: var(--red);
      color: #fff;
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translateX(40px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes toastOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(40px); }
    }

    /* Refresh spin animation */
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spinning { animation: spin 0.8s linear; }
  </style>
</head>
<body class="min-h-screen">

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- Nav -->
  <nav class="sticky top-0 z-50 border-b border-[var(--border)]" style="background:var(--nav-bg);backdrop-filter:saturate(180%) blur(20px);">
    <div class="max-w-6xl mx-auto px-6 h-12 flex items-center justify-between">
      <div class="flex items-center gap-2.5">
        <svg class="w-5 h-5 text-[var(--accent)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/><path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"/>
        </svg>
        <span class="text-sm font-semibold tracking-tight">Flower FL</span>
      </div>
      <div class="flex items-center gap-4">
        <div id="cluster-status" class="flex items-center gap-1.5 text-xs text-[var(--text-secondary)]">
          <span class="w-1.5 h-1.5 rounded-full bg-[var(--text-tertiary)]"></span>
          Connecting
        </div>
        <div id="last-updated" class="text-[10px] text-[var(--text-tertiary)] mono"></div>
        <button id="refresh-btn" class="w-7 h-7 flex items-center justify-center rounded-md hover:bg-[var(--border)] transition-colors" aria-label="Refresh now" title="Refresh now">
          <svg class="w-3.5 h-3.5 text-[var(--text-secondary)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
          </svg>
        </button>
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode"></button>
      </div>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-6 py-8 space-y-5">

    <!-- Status Bar -->
    <section class="card px-5 py-2.5 flex items-center justify-between">
      <div class="flex items-center gap-6">
        <div class="flex items-center gap-2">
          <span class="text-[11px] font-medium text-[var(--text-tertiary)] uppercase tracking-wider">Nodes</span>
          <span id="kpi-nodes" class="text-sm font-semibold mono">--</span>
        </div>
        <div class="w-px h-4 bg-[var(--border)]"></div>
        <div class="flex items-center gap-2">
          <span class="text-[11px] font-medium text-[var(--text-tertiary)] uppercase tracking-wider">Workers</span>
          <span id="kpi-connected" class="text-sm font-semibold mono text-[var(--accent)]">--</span>
        </div>
        <div class="w-px h-4 bg-[var(--border)]"></div>
        <div class="flex items-center gap-2">
          <span class="text-[11px] font-medium text-[var(--text-tertiary)] uppercase tracking-wider">Status</span>
          <span id="kpi-status" class="text-sm font-semibold">--</span>
        </div>
        <div class="w-px h-4 bg-[var(--border)]"></div>
        <div class="flex items-center gap-2">
          <span class="text-[11px] font-medium text-[var(--text-tertiary)] uppercase tracking-wider">Round</span>
          <span id="kpi-round" class="text-sm font-semibold mono">--</span>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <!-- Data upload inline -->
        <div id="cp-drop-zone" class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-dashed border-[var(--border)] cursor-pointer hover:border-[var(--accent)] transition-colors">
          <svg class="w-3.5 h-3.5 text-[var(--text-tertiary)] shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <span class="text-[11px] text-[var(--text-secondary)]">Upload Data</span>
          <input id="cp-file-input" type="file" class="hidden">
        </div>
        <div id="cp-upload-progress" class="hidden flex items-center gap-2">
          <span id="cp-upload-filename" class="text-[10px] text-[var(--text-secondary)] truncate max-w-[80px]"></span>
          <div class="w-16 h-1 rounded-full bg-[var(--progress-track)] overflow-hidden">
            <div id="cp-upload-bar" class="h-full rounded-full bg-[var(--accent)] transition-all duration-300" style="width:0%"></div>
          </div>
          <span id="cp-upload-pct" class="text-[10px] mono text-[var(--text-tertiary)]">0%</span>
        </div>
        <div id="cp-upload-status" class="hidden"></div>
        <button id="cp-new-btn" class="px-4 py-2 rounded-lg text-sm font-semibold text-white transition-colors hover:opacity-90" style="background:var(--accent)">
          New Training
        </button>
      </div>
    </section>

    <!-- Control Panel + Topology side by side -->
    <section class="grid grid-cols-5 gap-6">

    <!-- Left: Control Panel (2 cols) -->
    <div class="col-span-2 space-y-4">
      <h2 class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wider">Control Panel</h2>
      <div>

        <!-- Training Config -->
        <div class="card p-5 space-y-3">
          <p class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider">Training Config</p>

          <div>
            <label class="cp-label" for="cp-framework">Framework <span class="info-tip" data-tooltip="ML framework used by worker nodes for local training">i</span></label>
            <select id="cp-framework" class="cp-select">
              <option value="">Loading...</option>
            </select>
          </div>

          <div>
            <label class="cp-label" for="cp-strategy">Strategy <span class="info-tip" data-tooltip="Federated aggregation algorithm to combine worker updates">i</span></label>
            <select id="cp-strategy" class="cp-select">
              <option value="FedAvg">FedAvg</option>
              <option value="FedProx">FedProx</option>
              <option value="FedAdam">FedAdam</option>
            </select>
          </div>

          <!-- FedProx extra params -->
          <div id="cp-fedprox-params" class="hidden">
            <label class="cp-label" for="cp-proximal-mu">Proximal Mu <span class="info-tip" data-tooltip="Regularization strength — higher values keep local models closer to the global model">i</span></label>
            <input id="cp-proximal-mu" type="number" class="cp-input" value="1.0" step="0.1" min="0">
          </div>

          <!-- FedAdam extra params -->
          <div id="cp-fedadam-params" class="hidden space-y-2">
            <div>
              <label class="cp-label" for="cp-server-lr">Server LR (eta) <span class="info-tip" data-tooltip="Server-side learning rate for adaptive federated optimization">i</span></label>
              <input id="cp-server-lr" type="number" class="cp-input" value="0.01" step="0.001" min="0">
            </div>
            <div>
              <label class="cp-label" for="cp-tau">Tau <span class="info-tip" data-tooltip="Controls pseudo-gradient adaptivity — smaller values increase adaptivity">i</span></label>
              <input id="cp-tau" type="number" class="cp-input" value="0.1" step="0.01" min="0">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="cp-label" for="cp-rounds">Rounds <span class="info-tip" data-tooltip="Number of server-client communication rounds for the training run">i</span></label>
              <input id="cp-rounds" type="number" class="cp-input" value="3" min="1" max="100">
            </div>
            <div>
              <label class="cp-label" for="cp-epochs">Local Epochs <span class="info-tip" data-tooltip="Training passes over local data per round on each worker">i</span></label>
              <input id="cp-epochs" type="number" class="cp-input" value="1" min="1" max="50">
            </div>
          </div>

          <div>
            <label class="cp-label" for="cp-batch">Batch Size <span class="info-tip" data-tooltip="Number of samples per training step on each worker">i</span></label>
            <input id="cp-batch" type="number" class="cp-input" value="32" min="1" max="512">
          </div>

          <div class="flex gap-2 pt-1">
            <button id="cp-start-btn" class="flex-1 px-4 py-2 rounded-lg text-sm font-semibold text-white transition-colors" style="background:var(--green)">
              Start Training
            </button>
            <button id="cp-stop-btn" class="hidden px-4 py-2 rounded-lg text-sm font-semibold text-white transition-colors" style="background:var(--red)">
              Stop
            </button>
          </div>
        </div>

      </div>
    </div>

    <!-- Right: Topology (3 cols) -->
    <div class="col-span-3">
      <h2 class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wider mb-2">Network Topology</h2>
      <div class="card p-2">
        <svg id="topology-canvas" viewBox="0 0 800 320" xmlns="http://www.w3.org/2000/svg">
          <!-- Rendered by JS -->
        </svg>
      </div>
    </div>

    </section>

    <!-- Training Log (2/5) + Loss Chart (3/5) -->
    <section class="grid grid-cols-5 gap-6">
      <div class="col-span-2">
        <div class="card p-5 flex flex-col space-y-3 h-full">
          <div class="flex items-center justify-between">
            <p class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider">Training Log</p>
            <button id="cp-log-clear" class="text-[11px] text-[var(--text-tertiary)] hover:text-[var(--text-secondary)] transition-colors">Clear</button>
          </div>
          <div id="cp-log" class="log-terminal min-h-[160px] max-h-[280px] flex-1">Waiting for training to start...</div>
        </div>
      </div>
      <div class="col-span-3">
        <div class="card p-5 h-full">
          <p class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider mb-3">Loss Convergence</p>
          <canvas id="loss-chart" height="180"></canvas>
        </div>
      </div>
    </section>

    <!-- Round Details + Run Info + Model -->
    <section class="grid grid-cols-3 gap-6">
      <div>
        <div class="card overflow-hidden h-full">
          <p class="px-5 pt-4 pb-2 text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider">Round Details</p>
          <div id="rounds-table">
            <div class="px-6 py-8 text-center text-sm text-[var(--text-tertiary)]">Waiting for training data</div>
          </div>
        </div>
      </div>
      <div>
        <div class="card p-5 h-full">
          <p class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider mb-3">Run</p>
          <div id="run-info">
            <div class="text-sm text-[var(--text-tertiary)]">No active run</div>
          </div>
        </div>
      </div>
      <div>
        <div class="card p-5 h-full">
          <p class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider mb-3">Model</p>
          <div id="model-panel">
            <div class="text-sm text-[var(--text-tertiary)]">No model info</div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer class="border-t border-[var(--border)] mt-4 px-6 py-3">
    <div class="max-w-6xl mx-auto flex items-center justify-between text-[10px] text-[var(--text-tertiary)]">
      <span>Flower Federated Learning on OpenNebula</span>
      <span class="mono">Refreshes every 10s</span>
    </div>
  </footer>

<script src="/static/app.js?v=5"></script>
</body>
</html>
